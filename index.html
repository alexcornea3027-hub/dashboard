<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VCB — Robust PI viewer (debug)</title>
<style>
  body{font-family:Arial,sans-serif;background:#0b1220;color:#e6f7ff;margin:0;padding:18px}
  h1{margin:0 0 12px 0}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:#0f1724;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  thead th{color:#9fbef0}
  .ok{color:#7dd3fc}
  .err{color:#ff7a7a}
  pre{background:#071224;padding:8px;border-radius:6px;overflow:auto;max-height:280px}
  .controls{display:flex;gap:8px;margin-bottom:10px;align-items:center}
  button{padding:8px 10px;border-radius:6px;border:0;cursor:pointer;background:#122032;color:#eaf6ff}
</style>
</head>
<body>
  <h1>VCB — PI Dashboard (robust)</h1>

  <div class="controls">
    <button id="btnRefresh">Refresh</button>
    <button id="btnShowRaw">Toggle RAW JSON</button>
    <div id="fetchStatus" style="margin-left:8px" class="small">status: —</div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Daily Tasks</h3>
      <div id="dailyList">loading…</div>
    </div>

    <div class="card">
      <h3>Weekly Tasks</h3>
      <div id="weeklyList">loading…</div>
    </div>

    <div class="card" style="grid-column:1 / -1">
      <h3>PI — Daily by Area</h3>
      <table id="piTable">
        <thead><tr><th>Area</th><th style="text-align:right">Total</th><th style="text-align:right">Counted</th><th style="text-align:right">Behind %</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card" style="grid-column:1 / -1">
      <h3>DEBUG / RAW JSON</h3>
      <div id="debugInfo" style="margin-bottom:8px;color:#9aa4b2">debug info…</div>
      <pre id="rawJson" style="display:none">no data</pre>
    </div>
  </div>

<script>
/* ---------- helpers ---------- */
function safeNum(v){
  if (v === null || v === undefined) return 0;
  if (typeof v === 'number') return isFinite(v)?v:0;
  if (typeof v === 'string'){
    const s = v.replace(/\s/g,'').replace(/,/g,'');
    const n = Number(s);
    return isFinite(n)?n:0;
  }
  return 0;
}
function findKey(obj, candidates){
  if (!obj) return undefined;
  if (!Array.isArray(candidates)) candidates=[candidates];
  const keys = Object.keys(obj);
  for (const c of candidates){
    for (const k of keys){
      if (k.trim().toLowerCase() === c.trim().toLowerCase()) return k;
    }
  }
  for (const c of candidates){
    for (const k of keys){
      if (k.trim().toLowerCase().indexOf(c.trim().toLowerCase()) !== -1) return k;
    }
  }
  return undefined;
}
function isHeaderRow(obj){
  // header row typically has column names as values (strings like "Total locations", "Area")
  for (const v of Object.values(obj)){
    if (typeof v === 'string'){
      const s = v.trim().toLowerCase();
      if (s === 'area' || s === 'total locations' || s === 'counted' || s.indexOf('total') !== -1) return true;
    }
  }
  return false;
}

/* ---------- renderers ---------- */
function renderDaily(list){
  const el = document.getElementById('dailyList');
  el.innerHTML = '';
  if (!Array.isArray(list) || list.length === 0){ el.innerText = 'No daily tasks'; return; }
  list.forEach(item=>{
    const taskKey = findKey(item, ['Task ','Task','task']);
    const name = taskKey ? item[taskKey] : JSON.stringify(item).slice(0,50);
    const status = (item.Status || item['Status '] || item.status || '').toString();
    const done = status.toLowerCase().includes('complete') || status.toLowerCase().includes('done');
    const div = document.createElement('div');
    div.style.marginBottom='8px';
    div.innerHTML = `<strong>${escapeHtml(name)}</strong><br><span style="color:${done? '#7dd3fc':'#ff7a7a'}">${escapeHtml(status)}</span>`;
    el.appendChild(div);
  });
}

function renderWeekly(list){
  const el = document.getElementById('weeklyList');
  el.innerHTML = '';
  if (!Array.isArray(list) || list.length === 0){ el.innerText = 'No weekly tasks'; return; }
  list.forEach(item=>{
    const taskKey = findKey(item, ['Task','Task ']);
    const name = taskKey ? item[taskKey] : JSON.stringify(item).slice(0,50);
    const status = (item.Status || item['Status '] || item.status || '').toString();
    const done = status.toLowerCase().includes('complete') || status.toLowerCase().includes('done');
    const div = document.createElement('div');
    div.style.marginBottom='8px';
    div.innerHTML = `<strong>${escapeHtml(name)}</strong><br><span style="color:${done? '#7dd3fc':'#ff7a7a'}">${escapeHtml(status)}</span>`;
    el.appendChild(div);
  });
}

function renderPI(list){
  const tbody = document.querySelector('#piTable tbody');
  tbody.innerHTML = '';
  if (!Array.isArray(list) || list.length === 0) { tbody.innerHTML = '<tr><td colspan="4">No PI data</td></tr>'; return; }

  // determine keys from first non-header row
  let sample = list.find(r => !isHeaderRow(r)) || list[0];
  const areaKey = findKey(sample, ['Area','Area ','area']);
  const totalKey = findKey(sample, ['Total locations','Total locations ','Total','Total locations']);
  const countedKey = findKey(sample, ['Counted','Counted ']);
  const behindKey = findKey(sample, ['Behind %','Behind % ','Behind targe','Behind target']);

  // iterate rows
  for (const r of list){
    // skip header-like rows
    if (isHeaderRow(r)) continue;
    let area = r[areaKey] ?? r['Area'] ?? r['Area '] ?? '';
    if (!area) continue;
    // if row area is 'Total:' treat separately OR skip for chart; here we still render
    const total = safeNum(r[totalKey] ?? r['Total locations'] ?? r['Total locations ']);
    const counted = safeNum(r[countedKey] ?? r['Counted '] ?? r['Counted']);
    let behindRaw = (r[behindKey] ?? r['Behind %'] ?? r['Behind % '] ?? r['Behind targe'] ?? r['Behind target']);
    behindRaw = safeNum(behindRaw);
    // if behindRaw looks like fraction (0.01) -> convert to percent for display
    let behindPct = behindRaw;
    if (behindRaw > 0 && behindRaw <= 1) behindPct = behindRaw * 100;
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${escapeHtml(String(area))}</td>
      <td style="text-align:right">${formatNumber(total)}</td>
      <td style="text-align:right">${formatNumber(counted)}</td>
      <td style="text-align:right">${formatNumber(behindRaw)}</td>
      <td style="text-align:right">${Number(behindPct||0).toFixed(2)}%</td>
    </tr>`);
  }
}

/* ---------- utility UI ---------- */
function setFetchStatus(txt, isError){
  const el = document.getElementById('fetchStatus');
  el.textContent = 'status: ' + txt;
  el.className = isError ? 'err' : 'ok';
}
function showRaw(json){
  const pre = document.getElementById('rawJson');
  pre.textContent = JSON.stringify(json, null, 2);
  pre.style.display = pre.style.display === 'none' ? 'block' : 'none';
}

/* ---------- fetch and init ---------- */
const btnRefresh = document.getElementById('btnRefresh');
const btnShowRaw = document.getElementById('btnShowRaw');
btnRefresh.addEventListener('click', loadData);
btnShowRaw.addEventListener('click', ()=>{ showRaw(window.__lastPayload || {}); });

function loadData(){
  setFetchStatus('fetching ./data/dashboard.json ...', false);
  // try pasted raw? none here — this simple page fetches file
  fetch('./data/dashboard.json?_=' + Date.now())
    .then(r => {
      if (!r.ok) throw new Error('fetch status ' + r.status);
      return r.json();
    })
    .then(payload => {
      window.__lastPayload = payload;
      setFetchStatus('loaded JSON (' + (Array.isArray(payload.piData)?payload.piData.length:0) + ' pi rows)', false);
      renderDaily(payload.dailyTask || []);
      renderWeekly(payload.weeklyTask || []);
      renderPI(payload.piData || []);
      document.getElementById('debugInfo').textContent = 'Fetched from ./data/dashboard.json — rows: ' + (payload.meta?.rows || 'unknown');
      // show raw JSON collapsed by default
      document.getElementById('rawJson').textContent = JSON.stringify(payload, null, 2);
      document.getElementById('rawJson').style.display = 'none';
    })
    .catch(err => {
      console.error('fetch error', err);
      setFetchStatus('fetch failed: ' + err.message, true);
      document.getElementById('debugInfo').textContent = 'Fetch error — falling back to demo payload. See console for details.';
      // fallback demo (simple subset)
      const demo = window.__demoPayload || {
        piData:[
          {"Area ":"MPR","Total locations":14622,"Counted ":3936,"Behind %":0},
          {"Area ":"PB1","Total locations":4329,"Counted ":1189,"Behind %":0}
        ],
        dailyTask:[{"Task ":"PI Master file update","Status":"Not started"}],
        weeklyTask:[{"Task":"(Weekly) SLA","Status":"Completed"}],
        meta:{today:new Date().toLocaleDateString(), rows:0}
      };
      window.__lastPayload = demo;
      renderDaily(demo.dailyTask);
      renderWeekly(demo.weeklyTask);
      renderPI(demo.piData);
      document.getElementById('rawJson').textContent = JSON.stringify(demo, null, 2);
      document.getElementById('rawJson').style.display = 'block';
    });
}

// small helpers for display
function formatNumber(n){ n = Number(n) || 0; return n.toLocaleString(); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* init */
loadData();
</script>
</body>
</html>
