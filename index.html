<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock Team | 3D Mission Control — Fixed</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

<!-- Import map: maps bare "three" specifiers to CDN ESM build -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
    "three/": "https://cdn.jsdelivr.net/npm/three@0.158.0/"
  }
}
</script>

<!-- Chart.js (global UMD) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{--bg:#0f1216;--panel:rgba(255,255,255,.05);--border:rgba(255,255,255,.09);--text:#fff;--warm1:#ffb703;--warm2:#ff8c42;--accent:#ff6b6b;--cyan:#4fd1c5}
[data-theme="light"]{--bg:#f7f8fb;--panel:#fff;--border:#d6dce8;--text:#111}
*{box-sizing:border-box;margin:0;padding:0}html,body{height:100%}body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
.app{display:grid;grid-template-rows:68px 110px 1fr;gap:12px;padding:12px;height:100vh}
.top{display:flex;align-items:center;justify-content:space-between;padding:0 18px}
.logo{font-weight:800;font-size:1.2rem}.logo span{color:var(--warm1)}
.controls{display:flex;gap:8px;align-items:center}.btn{padding:8px 14px;border-radius:999px;border:none;font-weight:700;cursor:pointer;background:linear-gradient(135deg,var(--warm1),var(--warm2));color:#111}.small{padding:8px 10px;border-radius:10px;background:transparent;border:1px solid var(--border);color:var(--text);cursor:pointer}
.clock{display:flex;align-items:center;justify-content:center}.clock-card{display:flex;align-items:center;gap:14px;padding:12px 18px;border-radius:70px;background:var(--panel);border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,.4)}
#time{font-size:1.6rem;font-weight:800;letter-spacing:2px}#date{font-size:.8rem;color:var(--warm1)}
.main{display:grid;grid-template-columns:1.3fr 1fr;grid-template-rows:1fr 1fr;gap:14px;padding:6px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:14px;position:relative;overflow:hidden}
h3{font-size:.78rem;color:#bdbdbd;letter-spacing:1.6px;margin-bottom:8px}
.canvas3d{width:100%;height:100%;min-height:140px}#weekly3d{min-height:360px}
.tasks{height:100%;overflow:auto;padding-right:6px}.task{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);margin-bottom:10px}
.done{border-left:4px solid var(--cyan)}.badge{padding:6px 12px;border-radius:999px;font-weight:800;font-size:.75rem}.ok{background:var(--cyan);color:#000}.wait{background:#aaa;color:#000}
.tooltip{position:fixed;pointer-events:none;padding:8px 12px;border-radius:8px;background:rgba(0,0,0,0.8);color:#fff;z-index:9999;display:none;transform:translate(-50%,-120%)}
.mini-charts{display:flex;gap:12px;align-items:stretch}.mini-charts canvas{flex:1;min-height:120px}
.footer-controls{position:absolute;right:12px;bottom:12px;display:flex;gap:8px}
@media (max-width:920px){.main{grid-template-columns:1fr;grid-template-rows:auto auto auto}#weekly3d{min-height:260px}}
</style>
</head>
<body data-theme="dark">
<div class="app">
  <div class="top">
    <div class="logo">STOCK TEAM <span>| VCB</span></div>
    <div class="controls">
      <button id="themeBtn" class="small">DARK / LIGHT</button>
      <button id="fsBtn" class="small">FULLSCREEN</button>
      <button id="reloadBtn" class="small">RELOAD DATA</button>
      <button id="playBtn" class="small">PAUSE</button>
      <button id="snapshotBtn" class="small">EXPORT WEEKLY PNG</button>
    </div>
  </div>

  <div class="clock">
    <div class="clock-card">
      <div id="hourglass" style="width:120px;height:88px" class="canvas3d"></div>
      <div>
        <div id="time">00:00:00</div>
        <div id="date">LOADING…</div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="card" style="grid-row:span 2">
      <h3>WEEKLY VOLUME · 3D WATERFALL + PARTICLES + TOOLTIP</h3>
      <div id="weekly3d" class="canvas3d"></div>
      <div class="footer-controls">
        <button id="fpsSlow" class="small">SLOW</button>
        <button id="fpsNormal" class="small">NORMAL</button>
        <button id="fpsFast" class="small">FAST</button>
      </div>
    </div>

    <div class="card">
      <h3>COUNTING PROGRESS · 3D DONUT</h3>
      <div id="donut3d" class="canvas3d"></div>
      <div style="margin-top:8px">
        <div class="mini-charts">
          <canvas id="miniLine"></canvas>
          <canvas id="miniDoughnut"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>DAILY TASKS</h3>
      <div class="tasks" id="tasks"></div>
    </div>
  </div>
</div>

<div id="tooltip" class="tooltip" aria-hidden="true"></div>

<!-- Main module: uses import map; OrbitControls resolves to three via import map -->
<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";

/* minimal utilities + behaviour: same as explained earlier
   This file is intentionally compact but complete — everything uses the "three" import that
   the importmap maps to the CDN ESM build, so the browser resolves correctly. 
   The rest of the code (scenes, loaders, charts) is the same functional approach used previously.
*/

const themeBtn = document.getElementById('themeBtn');
const fsBtn = document.getElementById('fsBtn');
const reloadBtn = document.getElementById('reloadBtn');
const playBtn = document.getElementById('playBtn');
const snapshotBtn = document.getElementById('snapshotBtn');
const tooltip = document.getElementById('tooltip');
const tasksContainer = document.getElementById('tasks');
const timeEl = document.getElementById('time');
const dateEl = document.getElementById('date');
const weeklyEl = document.getElementById('weekly3d');
const donutEl = document.getElementById('donut3d');
const hourglassEl = document.getElementById('hourglass');
const miniLineCtx = document.getElementById('miniLine').getContext('2d');
const miniDoughCtx = document.getElementById('miniDoughnut').getContext('2d');

let animationRunning = true;
let speedFactor = 1;

themeBtn.addEventListener('click', ()=> document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark');
fsBtn.addEventListener('click', ()=> { if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else document.exitFullscreen().catch(()=>{}); });
playBtn.addEventListener('click', ()=> { animationRunning = !animationRunning; playBtn.innerText = animationRunning ? 'PAUSE' : 'PLAY'; });
reloadBtn.addEventListener('click', ()=> loadDataAndBuild());
document.getElementById('fpsSlow').addEventListener('click', ()=> speedFactor = 0.6);
document.getElementById('fpsNormal').addEventListener('click', ()=> speedFactor = 1);
document.getElementById('fpsFast').addEventListener('click', ()=> speedFactor = 1.8);

/* data fallback */
const defaultData = {
  weekly:[6901,5447,4524,2068,1100],
  tasks:[
    {t:"Aged stock report 07:00", s:"Completed"},
    {t:"Aged stock report 15:00", s:"Pending"},
    {t:"Returns adjustments", s:"Pending"},
    {t:"PI First Count", s:"Pending"},
    {t:"SLA Master Sync", s:"Pending"},
    {t:"High Value Audit", s:"Pending"}
  ]
};

async function loadDataFromJSON(){
  try{
    const r = await fetch('./data.json', {cache:'no-cache'});
    if(!r.ok) throw new Error('no data.json');
    const j = await r.json();
    if(!j.weekly || !j.tasks) throw new Error('invalid data');
    return j;
  }catch(e){
    return defaultData;
  }
}

function renderTasks(tasks){
  tasksContainer.innerHTML = '';
  tasks.forEach(x=>{
    const d = document.createElement('div');
    d.className = `task ${x.s==='Completed'?'done':''}`;
    const statusText = x.s === 'Completed' ? 'READY' : (x.s||'Pending').toUpperCase();
    d.innerHTML = `<span>${x.t}</span><span class="badge ${x.s==='Completed'?'ok':'wait'}">${statusText}</span>`;
    tasksContainer.appendChild(d);
  });
}

/* clock */
let lastMinute = null;
setInterval(()=>{
  const d = new Date();
  timeEl.innerText = d.toLocaleTimeString('en-GB',{hour12:false});
  dateEl.innerText = d.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long'});
  if(d.getMinutes() !== lastMinute){
    lastMinute = d.getMinutes();
    if(hourglassGroup) hourglassGroup.rotation.y += Math.PI;
  }
},1000);

/* safe pixel ratio */
const DPR = ()=>Math.min(window.devicePixelRatio||1,2);

/* hourglass */
let hourglassGroup=null;
(function(){
  const scene = new THREE.Scene();
  const cam = new THREE.PerspectiveCamera(50, hourglassEl.clientWidth/hourglassEl.clientHeight, 0.1, 50);
  cam.position.set(0,1.5,3);
  const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  renderer.setPixelRatio(DPR());
  renderer.setSize(hourglassEl.clientWidth, hourglassEl.clientHeight);
  hourglassEl.appendChild(renderer.domElement);

  const gTop = new THREE.ConeGeometry(0.35,0.9,32);
  const gBot = new THREE.ConeGeometry(0.35,0.9,32); gBot.rotateX(Math.PI);
  const mat = new THREE.MeshStandardMaterial({color:0xffb703, metalness:0.4, roughness:0.25});
  hourglassGroup = new THREE.Group();
  const top = new THREE.Mesh(gTop,mat); top.position.y=0.44;
  const bot = new THREE.Mesh(gBot,mat); bot.position.y=-0.44;
  hourglassGroup.add(top,bot);

  const sandGeo = new THREE.BufferGeometry();
  const N = 120; const pos = new Float32Array(N*3);
  for(let i=0;i<N;i++){ pos[i*3]=(Math.random()-0.5)*0.18; pos[i*3+1]=Math.random()*0.7-0.35; pos[i*3+2]=(Math.random()-0.5)*0.18; }
  sandGeo.setAttribute('position', new THREE.BufferAttribute(pos,3));
  const sand = new THREE.Points(sandGeo, new THREE.PointsMaterial({size:0.035, color:0xffb703, sizeAttenuation:true}));
  hourglassGroup.add(sand);

  scene.add(hourglassGroup);
  scene.add(new THREE.AmbientLight(0xffffff,0.6));
  const pl = new THREE.PointLight(0xffb703,1); pl.position.set(3,3,3); scene.add(pl);

  function onResize(){ renderer.setSize(hourglassEl.clientWidth,hourglassEl.clientHeight); cam.aspect = hourglassEl.clientWidth/hourglassEl.clientHeight; cam.updateProjectionMatrix(); }
  window.addEventListener('resize', onResize);

  function loop(){ requestAnimationFrame(loop); sand.rotation.y += 0.009 * speedFactor; renderer.render(scene,cam); }
  loop();
})();

/* weekly & donut scenes - compact but reliable */
let weeklyRenderer, weeklyScene, weeklyCamera, weeklyControls, weeklyBars = [], weeklyParticles;
function createWeeklyScene(arr){
  if(weeklyRenderer && weeklyRenderer.domElement && weeklyRenderer.domElement.parentElement===weeklyEl) weeklyEl.removeChild(weeklyRenderer.domElement);
  weeklyScene = new THREE.Scene();
  weeklyCamera = new THREE.PerspectiveCamera(50, weeklyEl.clientWidth/weeklyEl.clientHeight, 0.1, 200);
  weeklyCamera.position.set(0,12,20);
  weeklyRenderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  weeklyRenderer.setPixelRatio(DPR()); weeklyRenderer.setSize(weeklyEl.clientWidth, weeklyEl.clientHeight); weeklyEl.appendChild(weeklyRenderer.domElement);

  weeklyScene.add(new THREE.AmbientLight(0xffffff,0.4));
  weeklyScene.add(new THREE.DirectionalLight(0xffb703,1.05).set(5,12,10));

  const max = Math.max(...arr);
  weeklyBars = [];
  arr.forEach((v,i)=>{
    const h = (v/max)*7 + 0.3;
    const mat = new THREE.MeshStandardMaterial({color:0xff8c42, metalness:0.45, roughness:0.28});
    const box = new THREE.Mesh(new THREE.BoxGeometry(1.2,h,1.2), mat);
    box.position.set((i - (arr.length-1)/2)*2.2, h/2, 0);
    weeklyScene.add(box); weeklyBars.push({mesh:box,height:h,value:v});
  });

  const pgeo = new THREE.BufferGeometry(); const pcount = 700; const positions = new Float32Array(pcount*3);
  for(let i=0;i<pcount;i++){ positions[i*3] = (Math.random()-0.5)*14; positions[i*3+1] = Math.random()*10+3; positions[i*3+2] = (Math.random()-0.5)*6; }
  pgeo.setAttribute('position', new THREE.BufferAttribute(positions,3));
  weeklyParticles = new THREE.Points(pgeo, new THREE.PointsMaterial({size:0.12, color:0xffb703, sizeAttenuation:true}));
  weeklyScene.add(weeklyParticles);

  weeklyControls = new OrbitControls(weeklyCamera, weeklyRenderer.domElement);
  weeklyControls.enableDamping = true; weeklyControls.enableZoom = true;

  const ray = new THREE.Raycaster(); const mouse = new THREE.Vector2();
  weeklyEl.addEventListener('pointermove', (ev)=>{ const r = weeklyEl.getBoundingClientRect(); const x = ev.clientX - r.left; const y = ev.clientY - r.top; mouse.x = (x/r.width)*2-1; mouse.y = -(y/r.height)*2+1; weeklyEl._lastPointer = {clientX:ev.clientX, clientY:ev.clientY}; });

  function animate(){ requestAnimationFrame(animate); weeklyParticles.rotation.y += 0.004 * speedFactor; weeklyBars.forEach(b=>{ b.mesh.position.y += (b.height/2 - b.mesh.position.y) * 0.06 * speedFactor; }); weeklyCamera.position.x = 12*Math.sin(perf.now()/6000); weeklyCamera.position.z = 12*Math.cos(perf.now()/6000); weeklyCamera.lookAt(0,3,0); weeklyControls.update();
    ray.setFromCamera(mouse, weeklyCamera);
    const intersects = ray.intersectObjects(weeklyBars.map(b=>b.mesh));
    if(intersects.length>0 && weeklyEl._lastPointer){ const hit = weeklyBars.find(b=>b.mesh===intersects[0].object); tooltip.style.display='block'; tooltip.style.left=(weeklyEl._lastPointer.clientX+12)+'px'; tooltip.style.top=(weeklyEl._lastPointer.clientY-10)+'px'; tooltip.innerText = `Value: ${hit.value}`; } else tooltip.style.display='none';
    weeklyRenderer.render(weeklyScene, weeklyCamera);
  }
  animate();
}

let donutRenderer;
function createDonut(arr){
  if(donutRenderer && donutRenderer.domElement && donutRenderer.domElement.parentElement===donutEl) donutEl.removeChild(donutRenderer.domElement);
  const scene = new THREE.Scene();
  const cam = new THREE.PerspectiveCamera(50, donutEl.clientWidth/donutEl.clientHeight, 0.1, 100);
  cam.position.set(0,0,8);
  donutRenderer = new THREE.WebGLRenderer({antialias:true, alpha:true}); donutRenderer.setPixelRatio(DPR()); donutRenderer.setSize(donutEl.clientWidth, donutEl.clientHeight); donutEl.appendChild(donutRenderer.domElement);
  scene.add(new THREE.AmbientLight(0xffffff,0.5)); const l = new THREE.PointLight(0xffb703,1.1); l.position.set(4,4,4); scene.add(l);
  const total = arr.reduce((a,b)=>a+b,0); const maxTotal = 30000; const fraction = Math.min(total/maxTotal,1); const arc = fraction*Math.PI*2;
  const tor = new THREE.Mesh(new THREE.TorusGeometry(2.6,0.55,32,160,arc), new THREE.MeshStandardMaterial({color:0xff8c42, metalness:0.6, roughness:0.25})); scene.add(tor);
  function loop(){ requestAnimationFrame(loop); tor.rotation.y += 0.01*speedFactor; donutRenderer.render(scene,cam); } loop();

  // small Chart.js charts
  try {
    if(window.miniLineChart) window.miniLineChart.destroy();
    window.miniLineChart = new Chart(miniLineCtx, {type:'line', data:{labels:arr.map((_,i)=>`W${i+1}`), datasets:[{data:arr, borderColor:'#ff8c42', backgroundColor:'rgba(255,140,66,0.12)', tension:0.35, borderWidth:2, pointRadius:3}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{display:false}, ticks:{display:false}}}}});
    if(window.miniDoughChart) window.miniDoughChart.destroy();
    const used = Math.min(total,30000); const rem = Math.max(0,30000-total);
    window.miniDoughChart = new Chart(miniDoughCtx, {type:'doughnut', data:{labels:['Used','Remaining'], datasets:[{data:[used,rem], backgroundColor:['#ffb703','#333333']} ]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}});
  } catch(e){ console.warn('chart error', e); }
}

async function loadDataAndBuild(){
  const data = await loadDataFromJSON();
  const weekly = Array.isArray(data.weekly)?data.weekly.slice():defaultData.weekly.slice();
  const tasks = Array.isArray(data.tasks)?data.tasks.slice():defaultData.tasks.slice();
  renderTasks(tasks);
  createWeeklyScene(weekly);
  createDonut(weekly);
}
loadDataAndBuild();

/* snapshot */
document.getElementById('snapshotBtn').addEventListener('click', ()=> {
  try {
    if(weeklyRenderer && weeklyRenderer.domElement) {
      const url = weeklyRenderer.domElement.toDataURL('image/png');
      const a = document.createElement('a'); a.href = url; a.download = 'weekly_snapshot.png'; document.body.appendChild(a); a.click(); a.remove();
    }
  } catch(e){ console.error('snapshot', e); alert('Snapshot failed — see console.'); }
});

</script>
</body>
</html>
