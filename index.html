import React, { useEffect, useState, useRef } from "react";
import {
  PieChart, Pie, Cell,
  BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, ResponsiveContainer,
  LineChart, Line, Legend, ComposedChart
} from 'recharts';

// Default warm palette
const COLORS = ["#ff8a65", "#ff7043", "#ff5722", "#ffab91", "#ffccbc", "#ffd54f", "#ffb74d", "#ffa726", "#ff8f00", "#ff6f00"];

export default function VCBStockTeam() {
  const [data, setData] = useState(null);
  const [theme, setTheme] = useState('light');
  const [now, setNow] = useState(new Date());
  const hourglassRef = useRef(null);
  const particlesRef = useRef(null);

  useEffect(() => {
    fetch('/data/dashboard.json')
      .then(r => r.json())
      .then(j => setData(j))
      .catch(e => console.error('Could not load /data/dashboard.json', e));
  }, []);

  // Clock + minute tick
  useEffect(() => {
    const tick = () => setNow(new Date());
    const msToNextMinute = (60 - new Date().getSeconds()) * 1000 - new Date().getMilliseconds();
    const timeout = setTimeout(() => {
      tick();
      // rotate hourglass once each minute (brief animation toggle)
      if (hourglassRef.current) {
        hourglassRef.current.classList.remove('hg-rotate');
        // force reflow
        // eslint-disable-next-line
        hourglassRef.current.offsetWidth;
        hourglassRef.current.classList.add('hg-rotate');
      }
      const interval = setInterval(tick, 60 * 1000);
      // store so we can clear on unmount
      (V._intervals || (V._intervals = [])).push(interval);
    }, msToNextMinute);

    const V = window; // hold intervals
    (V._timeouts || (V._timeouts = [])).push(timeout);

    return () => {
      (V._timeouts || []).forEach(t => clearTimeout(t));
      (V._intervals || []).forEach(i => clearInterval(i));
    };
  }, []);

  // Particles background simple canvas
  useEffect(() => {
    const canvas = particlesRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let w = canvas.width = canvas.offsetWidth;
    let h = canvas.height = canvas.offsetHeight;
    let particles = [];
    const create = n => {
      particles = Array.from({ length: n }).map(() => ({
        x: Math.random() * w,
        y: Math.random() * h,
        r: 1 + Math.random() * 2,
        vx: (Math.random() - 0.5) * 0.3,
        vy: (Math.random() - 0.5) * 0.3,
        alpha: 0.1 + Math.random() * 0.7
      }));
    };
    create(80);
    let raf;
    const draw = () => {
      ctx.clearRect(0, 0, w, h);
      particles.forEach(p => {
        p.x += p.vx; p.y += p.vy;
        if (p.x < 0) p.x = w; if (p.x > w) p.x = 0;
        if (p.y < 0) p.y = h; if (p.y > h) p.y = 0;
        ctx.beginPath();
        ctx.globalAlpha = p.alpha;
        ctx.fillStyle = '#fff';
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fill();
      });
      raf = requestAnimationFrame(draw);
    };
    draw();
    const onResize = () => { w = canvas.width = canvas.offsetWidth; h = canvas.height = canvas.offsetHeight; create(80); };
    window.addEventListener('resize', onResize);
    return () => { cancelAnimationFrame(raf); window.removeEventListener('resize', onResize); };
  }, []);

  // Helpers
  const toTitle = s => s && s[0] ? s[0].toUpperCase() + s.slice(1) : s;

  const completedCount = (list) => list ? list.filter(t => t.status && t.status.toLowerCase().includes('completed')).length : 0;
  const pendingCount = (list) => list ? list.length - completedCount(list) : 0;

  const toggleTheme = () => {
    const next = theme === 'light' ? 'dark' : 'light';
    setTheme(next);
    document.documentElement.classList.toggle('dark', next === 'dark');
  };

  const goFull = () => {
    const el = document.documentElement;
    if (!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.();
  };

  // Render loaders
  if (!data) return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-slate-800 dark:to-slate-900">
      <div className="text-center p-6 rounded-2xl shadow-2xl bg-white/80 dark:bg-slate-900/70">
        <h2 className="text-2xl font-bold">VCB StockTeam — Loading data...</h2>
        <p className="mt-2 text-sm text-slate-600 dark:text-slate-300">Fetching <code>/data/dashboard.json</code></p>
      </div>
    </div>
  );

  // Prepare chart data
  const counting = data.counting || [];
  const pieData = counting.filter(c => c.area && c.area !== 'Total:' && c.qty >= 0).map((c, i) => ({ name: c.area, value: c.qty, color: COLORS[i % COLORS.length] }));

  const dailyTasks = data.dailyTasks || [];
  const weeklyTasks = data.weeklyTasks || [];
  const history = data.history || [];

  // Simple weekly/daily completion bars
  const dailyCompletion = [{ name: 'Completed', value: completedCount(dailyTasks) }, { name: 'Pending', value: pendingCount(dailyTasks) }];
  const weeklyCompletion = [{ name: 'Completed', value: completedCount(weeklyTasks) }, { name: 'Pending', value: pendingCount(weeklyTasks) }];

  // Build history chart format
  const historyChart = history.map((h, i) => ({ week: h.week || `W${i}`, total: Number(h.total || 0) }));

  // Waterfall: show area deltas as a cumulative bar (visual waterfall)
  let cumulative = 0;
  const waterfall = pieData.map(p => {
    const start = cumulative; cumulative += p.value; return { name: p.name, value: p.value, start };
  });

  return (
    <div className="min-h-screen p-6 bg-gradient-to-br from-yellow-50 to-orange-100 dark:from-slate-900 dark:to-slate-800 text-slate-900 dark:text-slate-100">
      <canvas ref={particlesRef} className="pointer-events-none fixed inset-0 opacity-20 mix-blend-screen"></canvas>

      <header className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-2xl font-extrabold">VCB StockTeam — Dashboard</h1>
          <div className="text-sm text-slate-600 dark:text-slate-300">Data source: <code>/data/dashboard.json</code></div>
        </div>
        <div className="flex items-center gap-3">
          <button onClick={toggleTheme} className="px-3 py-2 rounded-lg bg-white/70 dark:bg-slate-700/60 shadow">Theme: {theme}</button>
          <button onClick={goFull} className="px-3 py-2 rounded-lg bg-white/70 dark:bg-slate-700/60 shadow">Fullscreen</button>
        </div>
      </header>

      <main className="grid grid-cols-12 gap-6">
        {/* Left - big stats + charts */}
        <section className="col-span-8 rounded-2xl p-6 shadow-lg bg-white/80 dark:bg-slate-900/60">
          <div className="flex gap-6 items-center">
            <div className="flex-1 text-center py-6 px-4">
              <div className="text-6xl font-extrabold leading-tight">{now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
              <div className="text-sm mt-1">{now.toLocaleDateString()}</div>
            </div>

            <div className="w-28 h-28 flex flex-col items-center justify-center rounded-xl bg-orange-50 dark:bg-slate-800/40">
              <div ref={hourglassRef} className="text-4xl transition-transform duration-800 transform hg-rotate-once" style={{ animationDuration: '1s' }}>⏳</div>
              <div className="text-xs mt-2">minute tick</div>
            </div>
          </div>

          <div className="mt-6 grid grid-cols-2 gap-4">
            <div className="p-4 rounded-lg bg-white/60 dark:bg-slate-800/50 shadow-sm">
              <h3 className="font-semibold">Daily Tasks — Completed vs Pending</h3>
              <div style={{ height: 180 }} className="mt-3">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={dailyCompletion}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="name" />
                    <YAxis />
                    <Tooltip />
                    <Bar dataKey="value" fill="#ff7043" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="p-4 rounded-lg bg-white/60 dark:bg-slate-800/50 shadow-sm">
              <h3 className="font-semibold">Weekly Tasks — Completed vs Pending</h3>
              <div style={{ height: 180 }} className="mt-3">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={weeklyCompletion}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="name" />
                    <YAxis />
                    <Tooltip />
                    <Bar dataKey="value" fill="#ffa726" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>
          </div>

          <div className="mt-6 grid grid-cols-2 gap-4">
            <div className="p-4 rounded-lg bg-white/60 dark:bg-slate-800/50 shadow-sm">
              <h3 className="font-semibold">Inventory Distribution (areas)</h3>
              <div style={{ height: 260 }} className="mt-3">
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie data={pieData} dataKey="value" nameKey="name" outerRadius={80} fill="#8884d8">
                      {pieData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color} />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="p-4 rounded-lg bg-white/60 dark:bg-slate-800/50 shadow-sm">
              <h3 className="font-semibold">Weekly History (Totals)</h3>
              <div style={{ height: 260 }} className="mt-3">
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={historyChart}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="week" />
                    <YAxis />
                    <Tooltip />
                    <Line type="monotone" dataKey="total" stroke="#ff8a65" strokeWidth={3} dot={{ r: 3 }} />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </div>
          </div>

          <div className="mt-6 p-4 rounded-lg bg-white/60 dark:bg-slate-800/50 shadow-sm">
            <h3 className="font-semibold">Waterfall view (cumulative by area)</h3>
            <div style={{ height: 110 }} className="mt-3">
              <ResponsiveContainer width="100%" height="100%">
                <ComposedChart data={waterfall}>
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="value" stackId="a" fill="#ff6f00" />
                </ComposedChart>
              </ResponsiveContainer>
            </div>
          </div>
        </section>

        {/* Right - tasks and meta */}
        <aside className="col-span-4 space-y-6">
          <div className="rounded-2xl p-4 shadow-lg bg-white/80 dark:bg-slate-900/60">
            <h2 className="text-lg font-bold">Summary</h2>
            <div className="mt-3 grid grid-cols-2 gap-2">
              <div className="p-3 rounded-lg bg-orange-50 dark:bg-slate-800/40">
                <div className="text-sm">Target</div>
                <div className="text-2xl font-extrabold">{data.metadata?.target ?? '-'}</div>
              </div>
              <div className="p-3 rounded-lg bg-orange-50 dark:bg-slate-800/40">
                <div className="text-sm">Timestamp</div>
                <div className="text-2xl font-extrabold">{data.metadata?.timestamp ?? '-'}</div>
              </div>
            </div>

            <div className="mt-4">
              <h3 className="font-semibold">Counts</h3>
              <ul className="mt-2 max-h-48 overflow-auto">
                {counting.map((c, i) => (
                  <li key={i} className="flex justify-between py-1 border-b border-transparent last:border-0">
                    <span>{c.area}</span>
                    <span className="font-medium">{c.qty}</span>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <div className="rounded-2xl p-4 shadow-lg bg-white/80 dark:bg-slate-900/60">
            <h2 className="text-lg font-bold">Daily Tasks</h2>
            <ul className="mt-3 space-y-2 max-h-64 overflow-auto">
              {dailyTasks.map((t, i) => (
                <li key={i} className="flex items-center justify-between p-2 rounded-md" style={{ background: t.status && t.status.toLowerCase().includes('completed') ? 'rgba(76,175,80,0.08)' : 'rgba(255,87,34,0.04)' }}>
                  <div>
                    <div className="font-medium">{t.name}</div>
                    <div className="text-xs text-slate-500 dark:text-slate-300">{t.status}</div>
                  </div>
                  <div className={`text-xs px-2 py-1 rounded-full ${t.status && t.status.toLowerCase().includes('completed') ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}`}>{t.status && t.status.toLowerCase().includes('completed') ? 'Completed' : 'Pending'}</div>
                </li>
              ))}
            </ul>
          </div>

          <div className="rounded-2xl p-4 shadow-lg bg-white/80 dark:bg-slate-900/60">
            <h2 className="text-lg font-bold">Weekly Tasks</h2>
            <ul className="mt-3 space-y-2 max-h-64 overflow-auto">
              {weeklyTasks.map((t, i) => (
                <li key={i} className="flex items-center justify-between p-2 rounded-md" style={{ background: t.status && t.status.toLowerCase().includes('completed') ? 'rgba(76,175,80,0.08)' : 'rgba(255,87,34,0.04)' }}>
                  <div>
                    <div className="font-medium">{t.name}</div>
                    <div className="text-xs text-slate-500 dark:text-slate-300">{t.status}</div>
                  </div>
                  <div className={`text-xs px-2 py-1 rounded-full ${t.status && t.status.toLowerCase().includes('completed') ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}`}>{t.status && t.status.toLowerCase().includes('completed') ? 'Completed' : 'Pending'}</div>
                </li>
              ))}
            </ul>
          </div>
        </aside>
      </main>

      <style jsx>{`
        .hg-rotate { transform: rotate(360deg); transition: transform 700ms ease-in-out; }
        /* ensure dark theme support */
        :root { --bg: #fff; }
        .dark :root { --bg: #0b1220; }
      `}</style>
    </div>
  );
}
