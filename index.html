<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Stock Team VCB</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg: #041226;
    --panel: #071227;
    --muted:#98a8bd;
    --accentA:#7dd3fc;
    --accentB:#8b5cf6;
    --done:#12b76a;
    --todo:#f97316;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Arial;background:linear-gradient(180deg,#021026,#05122a);color:#eaf6ff}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px}
  h1{margin:0;font-size:20px}
  .actions{display:flex;gap:8px;align-items:center}
  button, select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--accentA);cursor:pointer}
  button.primary{background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#021026;border:0}
  .layout{display:grid;grid-template-columns:320px 1fr 420px;gap:12px;height:calc(100vh - 72px);padding:12px}
  .panel{background:var(--panel);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 40px rgba(2,6,23,0.45);display:flex;flex-direction:column;min-height:0;overflow:hidden}
  .taskList{overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:6px}
  .taskCard{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.015),rgba(0,0,0,0.05));border:1px solid rgba(255,255,255,0.02);transition:0.2s}
  .taskCard:hover{background:rgba(255,255,255,0.03)}
  .badge{padding:6px 14px;border-radius:999px;color:#fff;font-weight:700;font-size:12px;text-align:center;white-space:nowrap}
  .done{background:linear-gradient(90deg,var(--done),#065f46);}
  .todo{background:linear-gradient(90deg,var(--todo),#b91c1c);}
  .charts{display:grid;grid-template-rows:1fr 1fr;gap:12px;min-height:0}
  .chartRow{display:flex;gap:12px;min-height:0}
  .chartCard{flex:1;display:flex;flex-direction:column;border-radius:10px;padding:8px;background:rgba(255,255,255,0.02);min-height:0}
  .chartTitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-weight:600;color:#cfeeff}
  .canvasWrap{flex:1;min-height:0}
  canvas{width:100% !important;height:100% !important;display:block}
  table{width:100%;border-collapse:collapse;color:#eaf6ff;font-size:13px}
  thead th{position:sticky;top:0;background:rgba(10,14,24,0.35);padding:8px;color:var(--muted);font-weight:700;text-align:left}
  td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
  #debug{margin-top:8px;background:#071427;color:#fff;padding:8px;border-radius:8px;font-size:13px;max-height:140px;overflow:auto}
  .small{font-size:12px;color:var(--muted)}
  body,html{overflow:hidden}
  @media(max-width:1100px){ .layout{grid-template-columns:1fr;grid-auto-rows:auto;height:calc(100vh - 72px)} body,html{overflow:auto} }
</style>
</head>
<body>
<header>
  <div>
    <h1>Stock Team VCB</h1>
    <div class="small" id="metaLine">Live • <span id="liveDate">—</span></div>
  </div>

  <div class="actions">
    <select id="scaleMode" title="Scale mode">
      <option value="auto">Auto scale</option>
      <option value="raw">Raw</option>
      <option value="log">Log</option>
    </select>
    <button id="refreshBtn">Refresh</button>
    <button id="uploadBtn">Upload JSON</button>
    <button id="pasteBtn">Paste JSON</button>
    <button id="exportCsv">Export CSV</button>
    <button id="exportPng" class="primary">Export PNGs</button>
  </div>
</header>

<div class="layout">
  <!-- LEFT: tasks -->
  <div class="panel">
    <h3 style="margin:0 0 8px 0">Daily tasks</h3>
    <div id="dailyList" class="taskList"></div>
    <div style="height:10px"></div>
    <h3 style="margin:8px 0 8px 0">Weekly tasks</h3>
    <div id="weeklyList" class="taskList"></div>
  </div>

  <!-- CENTER: charts -->
  <div class="panel charts">
    <div class="chartRow">
      <div class="chartCard">
        <div class="chartTitle"><div>Counted vs Remaining (Top areas)</div><div class="small" id="countHint">—</div></div>
        <div class="canvasWrap"><canvas id="piBar"></canvas></div>
      </div>
      <div class="chartCard">
        <div class="chartTitle"><div>Weekly PI — Series</div><div class="small" id="weekHint">—</div></div>
        <div class="canvasWrap"><canvas id="weeklyLine"></canvas></div>
      </div>
    </div>

    <div class="chartRow">
      <div class="chartCard">
        <div class="chartTitle"><div>Daily tasks</div><div class="small" id="dailyCountSmall">—</div></div>
        <div class="canvasWrap"><canvas id="dailyDonut"></canvas></div>
      </div>
      <div class="chartCard">
        <div class="chartTitle"><div>Weekly tasks</div><div class="small" id="weeklyCountSmall">—</div></div>
        <div class="canvasWrap"><canvas id="weeklyDonut"></canvas></div>
      </div>
    </div>
  </div>

  <!-- RIGHT: gauge + tables -->
  <div class="panel">
    <h3 style="margin:0 0 8px 0">Daily progress (gauge)</h3>
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
      <div style="width:140px;height:120px"><canvas id="gaugeMini"></canvas></div>
      <div>
        <div id="gaugeCenterText" style="font-weight:800;font-size:18px">—</div>
        <div id="gaugeBreakdown" class="small">—</div>
      </div>
    </div>

    <h3 style="margin-top:6px">PI — Daily by area</h3>
    <div style="flex:1;overflow:auto;margin-bottom:8px">
      <table id="piTable"><thead><tr><th>Area</th><th style="text-align:right">Daily Count</th><th style="text-align:right">Remaining</th></tr></thead><tbody></tbody></table>
    </div>

    <h3 style="margin-top:6px">Weekly details</h3>
    <div style="max-height:160px;overflow:auto">
      <table id="weeklyPiTable"><thead><tr><th>Week</th><th>Area</th><th style="text-align:right">Daily</th><th style="text-align:right">Weekly</th><th style="text-align:right">Weekly %</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<div id="debug" aria-live="polite"></div>

<script>
/* ---------- helpers ---------- */
function dbg(msg){ const el = document.getElementById('debug'); const d = document.createElement('div'); d.textContent = msg; el.appendChild(d); el.scrollTop = el.scrollHeight; console.log(msg);}
function safeNum(v){ if(v==null)return 0; if(typeof v==='number')return isFinite(v)?v:0; const n=Number(String(v).replace(/,/g,'')); return isFinite(n)?n:0;}
function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function findKey(obj,candidates){if(!obj)return undefined;if(!Array.isArray(candidates))candidates=[candidates];const ks=Object.keys(obj);for(const c of candidates){for(const k of ks){if(k.trim().toLowerCase()===c.trim().toLowerCase())return k;}}for(const c of candidates){for(const k of ks){if(k.trim().toLowerCase().indexOf(c.trim().toLowerCase())!==-1)return k;}}return undefined;}
function formatNumber(n){n=Number(n)||0;return n.toLocaleString();}

/* ---------- Chart plugins ---------- */
const donut3D = {
  id:'donut3D',
  beforeDraw(chart,args,options){
    if(!options||!options.depth)return;
    const ctx=chart.ctx;
    const meta=chart.getDatasetMeta(0);
    if(!meta)return;
    const first=meta.data[0];if(!first)return;
    const cx=(chart.chartArea.left+chart.chartArea.right)/2;
    const cy=(chart.chartArea.top+chart.chartArea.bottom)/2;
    const outerR=first.outerRadius||Math.min(chart.width,chart.height)/2*0.9;
    const innerR=first.innerRadius||outerR*0.6;
    const depth=options.depth;
    const slices=chart.data.datasets[0].data;
    const colors=chart.data.datasets[0].backgroundColor||[];
    let startAngle=(chart.options.rotation||0)-Math.PI/2;
    const total=slices.reduce((s,v)=>s+(typeof v==='number'?v:0),0)||1;
    const angles=[];
    for(let i=0;i<slices.length;i++){const a=(slices[i]/total)*(chart.options.circumference||2*Math.PI);angles.push({start:startAngle,end:startAngle+a});startAngle+=a;}
    const step=Math.max(2,Math.round(depth/6));
    for(let layer=depth;layer>0;layer-=step){
      const yOff=layer*0.6;
      for(let i=0;i<angles.length;i++){
        const ainfo=angles[i];
        ctx.beginPath();
        ctx.fillStyle=shadeColor(colors[i]||'rgba(255,255,255,0.08)',-0.12-(layer/depth)*0.12);
        ctx.moveTo(cx,cy+yOff);
        ctx.arc(cx,cy+yOff,outerR,ainfo.start,ainfo.end);
        ctx.arc(cx,cy+yOff,innerR,ainfo.end,ainfo.start,true);
        ctx.closePath();ctx.fill();
      }
    }
  }
};
const centerText={id:'centerText',afterDraw(chart){const cfg=chart?.config?.options?.plugins?.centerText;if(!cfg)return;const ctx=chart.ctx;ctx.save();const x=(chart.chartArea.left+chart.chartArea.right)/2;const y=(chart.chartArea.top+chart.chartArea.bottom)/2;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle=cfg.color||'#fff';ctx.font=cfg.font||'700 16px Poppins';ctx.fillText(cfg.text||'',x,y-8);if(cfg.subtext){ctx.font=cfg.subFont||'400 12px Poppins';ctx.fillStyle=cfg.subColor||'#cfeeff';ctx.fillText(cfg.subtext,x,y+14);}ctx.restore();}};
Chart.register(donut3D,centerText);

/* ---------- state ---------- */
let payload=null;
let charts={piBar:null,weeklyLine:null,dailyDonut:null,weeklyDonut:null,gaugeMini:null};
const DAILY_TARGET=1193;
const STORAGE_KEY='dailyProgress';

/* ---------- load and render ---------- */
document.getElementById('refreshBtn').addEventListener('click', loadAndRender);
document.getElementById('uploadBtn').addEventListener('click', onUpload);
document.getElementById('pasteBtn').addEventListener('click', onPaste);
document.getElementById('exportCsv').addEventListener('click', downloadCsv);
document.getElementById('exportPng').addEventListener('click', exportPNGs);
document.getElementById('scaleMode').addEventListener('change',()=>{if(payload)renderAll();});

async function loadAndRender(){
  dbg('Loading JSON...');
  payload=await tryLoadJson();
  if(!payload) payload=demoPayload();
  const today=new Date().toISOString().slice(0,10);
  document.getElementById('liveDate').innerText=today;
  renderAll();
}

/* ---------- demo payload ---------- */
function demoPayload(){
  return {
    piData:[{Area:'MPR',Counted:500},{Area:'PB1',Counted:300},{Area:'PB2',Counted:250}],
    dailyTask:[{Task:'Aged stock report 7AM',Status:'Completed'},{Task:'PI Master file update',Status:'Not started'}],
    weeklyTask:[{Task:'(Weekly) SLA',Status:'Completed'},{Task:'(Weekly) SIS report',Status:'Not started'}],
    weeklyPiData:[{WeekNo:27,Area:'MPR',DailyQty:127,WeeklyQty:5103,WeeklyPct:0.855}],
    meta:{today:new Date().toLocaleDateString(),rows:42}
  };
}

/* ---------- render pipeline ---------- */
function renderAll(){
  renderTasks(payload.dailyTask||[],'dailyList');
  renderTasks(payload.weeklyTask||[],'weeklyList');
  renderPI(payload.piData||[]);
  renderWeeklyPI(payload.weeklyPiData||[]);
  renderTaskDonuts(payload);
  computeAndRenderGauge(payload);
}

/* ---------- tasks ---------- */
function renderTasks(list,containerId){
  const el=document.getElementById(containerId); el.innerHTML='';
  if(!Array.isArray(list)||list.length===0){el.innerHTML='<div class="small">No tasks</div>';return;}
  for(const t of list){
    const nameKey=findKey(t,['Task ','Task','task']);
    const name=nameKey?t[nameKey]:JSON.stringify(t).slice(0,60);
    const status=t.Status||t['Status ']||t.status||'';
    const done=String(status).toLowerCase().includes('complete')||String(status).toLowerCase().includes('done');
    const div=document.createElement('div'); div.className='taskCard';
    div.innerHTML='<div style="max-width:70%"><div style="font-weight:800;font-size:13px">'+escapeHtml(name)+'</div><div class="small">'+escapeHtml(status)+'</div></div><div><div class="badge '+(done?'done':'todo')+'">'+(done?'Completed':'Not started')+'</div></div>';
    el.appendChild(div);
  }
}

/* ---------- PI table + bar ---------- */
function renderPI(piList){
  const tbody=document.querySelector('#piTable tbody'); tbody.innerHTML='';
  if(!piList.length){tbody.innerHTML='<tr><td colspan="3">No PI data</td></tr>'; if(charts.piBar){charts.piBar.destroy();charts.piBar=null;} return;}
  const todayProgress=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
  const labels=[]; const countedArr=[]; const remainingArr=[];
  for(const r of piList){
    const area=r.Area||r['Area ']; if(!area) continue;
    const counted=safeNum(r.Counted||0); 
    const prev= todayProgress[area]||0;
    const newCount=prev+counted;
    todayProgress[area]=newCount;
    labels.push(area);
    countedArr.push(newCount);
    remainingArr.push(Math.max(0,DAILY_TARGET-newCount));
    tbody.insertAdjacentHTML('beforeend','<tr><td>'+escapeHtml(area)+'</td><td style="text-align:right">'+newCount+'</td><td style="text-align:right">'+Math.max(0,DAILY_TARGET-newCount)+'</td></tr>');
  }
  localStorage.setItem(STORAGE_KEY,JSON.stringify(todayProgress));
  document.getElementById('countHint').innerText='Target per area: '+DAILY_TARGET+' • Areas: '+labels.length;
  try{if(charts.piBar)charts.piBar.destroy();}catch(e){;}
  const ctx=document.getElementById('piBar').getContext('2d');
  charts.piBar=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Counted',data:countedArr,backgroundColor:'#7dd3fc'},{label:'Remaining',data:remainingArr,backgroundColor:'#f97316'}]},options:{responsive:true,plugins:{legend:{position:'top',labels:{color:'#cfeeff'}}},scales:{y:{beginAtZero:true}}}});
}

/* ---------- Weekly PI ---------- */
function renderWeeklyPI(data){
  const tbody=document.querySelector('#weeklyPiTable tbody'); tbody.innerHTML='';
  if(!data||!data.length){tbody.innerHTML='<tr><td colspan="5">No weekly data</td></tr>'; if(charts.weeklyLine){charts.weeklyLine.destroy();charts.weeklyLine=null;} return;}
  const weekLabels=[], datasets={};
  for(const r of data){
    const wk=r.WeekNo; const area=r.Area; weekLabels.push('Week '+wk);
    datasets[area]=datasets[area]||[]; datasets[area].push(r.DailyQty||0);
    tbody.insertAdjacentHTML('beforeend','<tr><td>'+wk+'</td><td>'+escapeHtml(area)+'</td><td style="text-align:right">'+(r.DailyQty||0)+'</td><td style="text-align:right">'+(r.WeeklyQty||0)+'</td><td style="text-align:right">'+(r.WeeklyPct||0)+'</td></tr>');
  }
  try{if(charts.weeklyLine)charts.weeklyLine.destroy();}catch(e){}
  const ctx=document.getElementById('weeklyLine').getContext('2d');
  charts.weeklyLine=new Chart(ctx,{type:'line',data:{labels:weekLabels,datasets:Object.entries(datasets).map(([k,v],i)=>({label:k,data:v,borderColor:i%2===0?'#7dd3fc':'#8b5cf6',tension:0.2,fill:false}))},options:{responsive:true,plugins:{legend:{labels:{color:'#cfeeff'}}},scales:{y:{beginAtZero:true}}}});
}

/* ---------- task donuts ---------- */
function renderTaskDonuts(payload){
  const dailyDone=(payload.dailyTask||[]).filter(t=>String(t.Status||'').toLowerCase().includes('complete')).length;
  const dailyNot=(payload.dailyTask||[]).length-dailyDone;
  const weeklyDone=(payload.weeklyTask||[]).filter(t=>String(t.Status||'').toLowerCase().includes('complete')).length;
  const weeklyNot=(payload.weeklyTask||[]).length-weeklyDone;

  const dailyCtx=document.getElementById('dailyDonut').getContext('2d');
  const weeklyCtx=document.getElementById('weeklyDonut').getContext('2d');
  if(charts.dailyDonut)charts.dailyDonut.destroy();
  if(charts.weeklyDonut)charts.weeklyDonut.destroy();

  charts.dailyDonut=new Chart(dailyCtx,{type:'doughnut',data:{labels:['Done','Not Started'],datasets:[{data:[dailyDone,dailyNot],backgroundColor:['#12b76a','#f97316']}]},options:{plugins:{legend:{position:'bottom',labels:{color:'#cfeeff'}}}}});
  charts.weeklyDonut=new Chart(weeklyCtx,{type:'doughnut',data:{labels:['Done','Not Started'],datasets:[{data:[weeklyDone,weeklyNot],backgroundColor:['#12b76a','#f97316']}]},options:{plugins:{legend:{position:'bottom',labels:{color:'#cfeeff'}}}}});
  document.getElementById('dailyCountSmall').innerText=dailyDone+'/'+(dailyDone+dailyNot);
  document.getElementById('weeklyCountSmall').innerText=weeklyDone+'/'+(weeklyDone+weeklyNot);
}

/* ---------- gauge ---------- */
function computeAndRenderGauge(payload){
  const todayProgress=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
  const totalCounted=Object.values(todayProgress).reduce((a,v)=>a+v,0);
  const totalRemaining=Math.max(0,DAILY_TARGET*Object.keys(todayProgress).length-totalCounted);
  const ctx=document.getElementById('gaugeMini').getContext('2d');
  if(charts.gaugeMini)charts.gaugeMini.destroy();
  charts.gaugeMini=new Chart(ctx,{type:'doughnut',data:{labels:['Counted','Remaining'],datasets:[{data:[totalCounted,totalRemaining],backgroundColor:['#7dd3fc','#f97316']}]},options:{cutout:'70%',plugins:{legend:{display:false},centerText:{text:totalCounted,color:'#7dd3fc',subtext:'Remaining: '+totalRemaining,subColor:'#f97316'}}}});
  document.getElementById('gaugeCenterText').innerText=totalCounted;
  document.getElementById('gaugeBreakdown').innerText='Remaining: '+totalRemaining;
}

/* ---------- helpers for upload/paste ---------- */
function onUpload(){const f=document.createElement('input'); f.type='file'; f.accept='application/json'; f.onchange=async e=>{const file=e.target.files[0];if(!file)return;const txt=await file.text();try{payload=JSON.parse(txt);renderAll();}catch(e){dbg('JSON error: '+e)}}; f.click();}
function onPaste(){const txt=prompt('Paste JSON here'); if(!txt)return; try{payload=JSON.parse(txt);renderAll();}catch(e){dbg('JSON error: '+e)}}
async function tryLoadJson(){return null;}
function downloadCsv(){dbg('Export CSV not implemented in demo');}
function exportPNGs(){dbg('Export PNGs not implemented in demo');}

/* ---------- helpers ---------- */
function shadeColor(color,percent){const f=color.split(","),t=percent<0?0:255,p=Math.abs(percent),R=parseInt(f[0].slice(f[0].indexOf('(')+1)),G=parseInt(f[1]),B=parseInt(f[2]);return "rgb("+(Math.round((t-R)*p)+R)+","+(Math.round((t-G)*p)+G)+","+(Math.round((t-B)*p)+B)+")";}

/* ---------- init ---------- */
loadAndRender();
</script>
</body>
</html>
