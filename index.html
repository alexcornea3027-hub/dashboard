<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Stock Team VCB</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg: #041226;
    --panel: #071227;
    --muted:#98a8bd;
    --accentA:#7dd3fc;
    --accentB:#8b5cf6;
    --done:#12b76a;
    --todo:#f97316;
  }
  *{box-sizing:border-box;}
  html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Arial;background:linear-gradient(180deg,#021026,#05122a);color:#eaf6ff;overflow:hidden;}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;}
  h1{margin:0;font-size:20px;}
  .actions{display:flex;gap:8px;align-items:center;}
  button, select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--accentA);cursor:pointer;}
  button.primary{background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#021026;border:0;}
  .layout{display:grid;grid-template-columns:320px 1fr 420px;gap:12px;height:calc(100vh - 72px);padding:12px;}
  .panel{background:var(--panel);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 40px rgba(2,6,23,0.45);display:flex;flex-direction:column;min-height:0;overflow:hidden;}
  .taskList{overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:6px;}
  .taskCard{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.015),rgba(0,0,0,0.05));border:1px solid rgba(255,255,255,0.02);}
  .badge{padding:6px 12px;border-radius:999px;color:#fff;font-weight:800;text-align:center;}
  .done{background:linear-gradient(90deg,var(--done),#065f46);}
  .todo{background:linear-gradient(90deg,var(--todo),#b91c1c);}
  .charts{display:grid;grid-template-rows:1fr 1fr;gap:12px;min-height:0;}
  .chartRow{display:flex;gap:12px;min-height:0;}
  .chartCard{flex:1;display:flex;flex-direction:column;border-radius:10px;padding:8px;background:rgba(255,255,255,0.02);min-height:0;}
  .chartTitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
  .canvasWrap{flex:1;min-height:0;}
  canvas{width:100% !important;height:100% !important;display:block;}
  table{width:100%;border-collapse:collapse;color:#eaf6ff;font-size:13px;}
  thead th{position:sticky;top:0;background:rgba(10,14,24,0.35);padding:8px;color:var(--muted);font-weight:700;text-align:left;}
  td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);}
  #debug{margin-top:8px;background:#071427;color:#fff;padding:8px;border-radius:8px;font-size:13px;max-height:140px;overflow:auto;}
  .small{font-size:12px;color:var(--muted);}
  @media(max-width:1100px){ .layout{grid-template-columns:1fr;grid-auto-rows:auto;height:calc(100vh - 72px)} body,html{overflow:auto} }
</style>
</head>
<body>
<header>
  <div>
    <h1>Stock Team VCB</h1>
    <div class="small" id="metaLine">Live • <span id="liveDate">—</span></div>
  </div>
  <div class="actions">
    <select id="scaleMode" title="Scale mode">
      <option value="auto">Auto scale</option>
      <option value="raw">Raw</option>
      <option value="log">Log</option>
    </select>
    <button id="refreshBtn">Refresh</button>
    <button id="uploadBtn">Upload JSON</button>
    <button id="pasteBtn">Paste JSON</button>
    <button id="exportCsv">Export CSV</button>
    <button id="exportPng" class="primary">Export PNGs</button>
  </div>
</header>

<div class="layout">
  <!-- LEFT: tasks -->
  <div class="panel">
    <h3 style="margin:0 0 8px 0">Daily tasks</h3>
    <div id="dailyList" class="taskList"></div>
    <div style="height:10px"></div>
    <h3 style="margin:8px 0 8px 0">Weekly tasks</h3>
    <div id="weeklyList" class="taskList"></div>
  </div>

  <!-- CENTER: charts -->
  <div class="panel charts">
    <div class="chartRow">
      <div class="chartCard">
        <div class="chartTitle"><div style="font-weight:700">Counted vs Remaining (Top areas)</div><div class="small" id="countHint">—</div></div>
        <div class="canvasWrap"><canvas id="piBar"></canvas></div>
      </div>
      <div class="chartCard">
        <div class="chartTitle"><div style="font-weight:700">Weekly PI — Series</div><div class="small" id="weekHint">—</div></div>
        <div class="canvasWrap"><canvas id="weeklyLine"></canvas></div>
      </div>
    </div>

    <div class="chartRow">
      <div class="chartCard">
        <div class="chartTitle"><div style="font-weight:700">Daily tasks</div><div class="small" id="dailyCountSmall">—</div></div>
        <div class="canvasWrap"><canvas id="dailyDonut"></canvas></div>
      </div>
      <div class="chartCard">
        <div class="chartTitle"><div style="font-weight:700">Weekly tasks</div><div class="small" id="weeklyCountSmall">—</div></div>
        <div class="canvasWrap"><canvas id="weeklyDonut"></canvas></div>
      </div>
    </div>
  </div>

  <!-- RIGHT: gauge + tables -->
  <div class="panel">
    <h3 style="margin:0 0 8px 0">Daily progress (gauge)</h3>
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
      <div style="width:140px;height:120px"><canvas id="gaugeMini"></canvas></div>
      <div>
        <div id="gaugeCenterText" style="font-weight:800;font-size:18px">—</div>
        <div id="gaugeBreakdown" class="small">—</div>
      </div>
    </div>

    <h3 style="margin-top:6px">PI — Daily by area</h3>
    <div style="flex:1;overflow:auto;margin-bottom:8px">
      <table id="piTable"><thead><tr><th>Area</th><th style="text-align:right">Counted Today</th></tr></thead><tbody></tbody></table>
    </div>

    <h3 style="margin-top:6px">Weekly details</h3>
    <div style="max-height:160px;overflow:auto">
      <table id="weeklyPiTable"><thead><tr><th>Week</th><th>Area</th><th style="text-align:right">Daily</th><th style="text-align:right">Weekly</th><th style="text-align:right">Weekly %</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<div id="debug" aria-live="polite"></div>

<script>
/* ---------- constants ---------- */
const DAILY_TARGET=1193; // fixed daily target
const STORAGE_KEY='dailyProgress_'+new Date().toISOString().slice(0,10); // per day

/* ---------- state ---------- */
let payload=null;
let charts={piBar:null,weeklyLine:null,dailyDonut:null,weeklyDonut:null,gaugeMini:null};

/* ---------- helpers ---------- */
function dbg(msg){const el=document.getElementById('debug');const d=document.createElement('div');d.textContent=msg;el.appendChild(d);el.scrollTop=el.scrollHeight; console.log(msg);}
function safeNum(v){if(v==null)return 0;return Number(v)||0;}
function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

/* ---------- chart plugins 3D ---------- */
const donut3D={id:'donut3D',beforeDraw(chart,args,opts){if(!opts||!opts.depth)return; const ctx=chart.ctx; const meta=chart.getDatasetMeta(0); if(!meta)return; const first=meta.data[0]; if(!first)return; const cx=(chart.chartArea.left+chart.chartArea.right)/2; const cy=(chart.chartArea.top+chart.chartArea.bottom)/2; const outerR=first.outerRadius||Math.min(chart.width,chart.height)/2*0.9; const innerR=first.innerRadius||outerR*0.6; const depth=opts.depth; const slices=chart.data.datasets[0].data; const colors=chart.data.datasets[0].backgroundColor||[]; let startAngle=(chart.options.rotation||0)-Math.PI/2; const total=slices.reduce((s,v)=>s+Number(v||0),0)||1; const angles=[]; for(let i=0;i<slices.length;i++){const a=(slices[i]/total)*(chart.options.circumference||(2*Math.PI)); angles.push({start:startAngle,end:startAngle+a}); startAngle+=a;} const step=Math.max(2,Math.round(depth/6)); for(let layer=depth;layer>0;layer-=step){const yOff=layer*0.6; for(let i=0;i<angles.length;i++){const ainfo=angles[i]; ctx.beginPath(); ctx.fillStyle=shadeColor(colors[i]||'rgba(255,255,255,0.08)',-0.12-(layer/depth)*0.12); ctx.moveTo(cx,cy+yOff); ctx.arc(cx,cy+yOff,outerR,ainfo.start,ainfo.end); ctx.arc(cx,cy+yOff,innerR,ainfo.end,ainfo.start,true); ctx.closePath(); ctx.fill();}}}};
const centerText={id:'centerText',afterDraw(chart){const cfg=chart?.config?.options?.plugins?.centerText; if(!cfg)return; const ctx=chart.ctx; ctx.save(); const x=(chart.chartArea.left+chart.chartArea.right)/2; const y=(chart.chartArea.top+chart.chartArea.bottom)/2; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle=cfg.color||'#fff'; ctx.font=cfg.font||'700 16px Poppins'; ctx.fillText(cfg.text||'',x,y-8); if(cfg.subtext){ctx.font=cfg.subFont||'400 12px Poppins';ctx.fillStyle=cfg.subColor||'#cfeeff';ctx.fillText(cfg.subtext,x,y+14);} ctx.restore();}};
Chart.register(donut3D,centerText);

/* ---------- load demo or real data ---------- */
async function loadAndRender(){
  dbg('Loading JSON...');
  try{ const res=await fetch('./data/dashboard.json'); payload=await res.json(); } catch(e){dbg('Using demo payload'); payload=demoPayload();}
  document.getElementById('liveDate').innerText=new Date().toLocaleDateString();
  renderAll();
}

function demoPayload(){
  return {
    piData:[{Area:'MPR',CountedToday:200},{Area:'PB1',CountedToday:150},{Area:'PB2',CountedToday:300}],
    dailyTask:[{Task:'Stock check 7AM',Status:'Completed'},{Task:'Update PI',Status:'Not started'}],
    weeklyTask:[{Task:'SLA weekly',Status:'Completed'},{Task:'SIS report',Status:'Not started'}],
    weeklyPiData:[{WeekNo:50,Area:'MPR',DailyQty:200,WeeklyQty:1400,WeeklyPct:0.8}],
  };
}

/* ---------- render pipeline ---------- */
function renderAll(){
  renderTasks(payload.dailyTask,'dailyList');
  renderTasks(payload.weeklyTask,'weeklyList');
  renderPI(payload.piData);
  renderWeeklyPI(payload.weeklyPiData);
  renderTaskDonuts(payload);
  computeAndRenderGauge(payload);
}

/* ---------- tasks ---------- */
function renderTasks(list,containerId){
  const el=document.getElementById(containerId); el.innerHTML='';
  if(!list||!list.length){el.innerHTML='<div class="small">No tasks</div>'; return;}
  list.sort((a,b)=>{const sa=(a.Status||'').toLowerCase(); const sb=(b.Status||'').toLowerCase(); return sa.includes('complete')?-1:1;});
  for(const t of list){
    const div=document.createElement('div'); div.className='taskCard';
    const done=(t.Status||'').toLowerCase().includes('complete');
    div.innerHTML='<div style="max-width:70%"><div style="font-weight:800;font-size:13px">'+escapeHtml(t.Task)+'</div><div class="small">'+escapeHtml(t.Status)+'</div></div><div><div class="badge '+(done?'done':'todo')+'">'+(done?'Completed':'Not started')+'</div></div>';
    el.appendChild(div);
  }
}

/* ---------- PI table + bar ---------- */
function renderPI(piList){
  const tbody=document.querySelector('#piTable tbody'); tbody.innerHTML='';
  if(!piList||!piList.length){tbody.innerHTML='<tr><td colspan="2">No data</td></tr>'; if(charts.piBar)charts.piBar.destroy(); return;}
  const labels=[],countedArr=[]; let totalCounted=0;
  for(const r of piList){labels.push(r.Area); countedArr.push(r.CountedToday); totalCounted+=safeNum(r.CountedToday);}
  const remaining=Math.max(0,DAILY_TARGET-totalCounted);
  countedArr.push(totalCounted); labels.push('Remaining');
  countedArr.push(remaining);
  try{if(charts.piBar)charts.piBar.destroy();}catch(e){}
  const ctx=document.getElementById('piBar').getContext('2d');
  charts.piBar=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Counted',data:countedArr,backgroundColor:['#7dd3fc','#f97316','#8b5cf6','#fbbf24']}]}});
  document.getElementById('countHint').innerText='Total counted today: '+totalCounted+' / '+DAILY_TARGET;
}

/* ---------- weekly PI ---------- */
function renderWeeklyPI(list){
  const tbody=document.querySelector('#weeklyPiTable tbody'); tbody.innerHTML='';
  if(!list||!list.length){tbody.innerHTML='<tr><td colspan="5">No weekly data</td></tr>'; if(charts.weeklyLine)charts.weeklyLine.destroy(); return;}
  const weekLabels=[],datasets={};
  for(const r of list){
    const wk=r.WeekNo; const area=r.Area; weekLabels.push('Week '+wk);
    datasets[area]=datasets[area]||[]; datasets[area].push(r.DailyQty||0);
    tbody.insertAdjacentHTML('beforeend','<tr><td>'+wk+'</td><td>'+escapeHtml(area)+'</td><td style="text-align:right">'+(r.DailyQty||0)+'</td><td style="text-align:right">'+(r.WeeklyQty||0)+'</td><td style="text-align:right">'+((r.WeeklyPct||0)*100).toFixed(2)+'%</td></tr>');
  }
  try{if(charts.weeklyLine)charts.weeklyLine.destroy();}catch(e){}
  const ctx=document.getElementById('weeklyLine').getContext('2d');
  charts.weeklyLine=new Chart(ctx,{type:'line',data:{labels:weekLabels,datasets:Object.entries(datasets).map(([k,v],i)=>({label:k,data:v,borderColor:i%2===0?'#7dd3fc':'#8b5cf6',tension:0.2,fill:false}))}});
}

/* ---------- task donuts ---------- */
function renderTaskDonuts(payload){
  const dailyDone=(payload.dailyTask||[]).filter(t=>t.Status.toLowerCase().includes('complete')).length;
  const dailyNot=(payload.dailyTask||[]).length-dailyDone;
  const weeklyDone=(payload.weeklyTask||[]).filter(t=>t.Status.toLowerCase().includes('complete')).length;
  const weeklyNot=(payload.weeklyTask||[]).length-weeklyDone;
  function renderDonut(id,done,not){
    try{if(charts[id])charts[id].destroy();}catch(e){}
    const ctx=document.getElementById(id).getContext('2d');
    charts[id]=new Chart(ctx,{type:'doughnut',data:{labels:['Completed','Not started'],datasets:[{data:[done,not],backgroundColor:['#12b76a','#f97316']}]},options:{plugins:{donut3D:{depth:8},centerText:{text:done+'/'+(done+not)}}}});
  }
  renderDonut('dailyDonut',dailyDone,dailyNot);
  renderDonut('weeklyDonut',weeklyDone,weeklyNot);
}

/* ---------- gauge ---------- */
function computeAndRenderGauge(payload){
  const totalCounted=(payload.piData||[]).reduce((s,r)=>s+safeNum(r.CountedToday),0);
  try{if(charts.gaugeMini)charts.gaugeMini.destroy();}catch(e){}
  const ctx=document.getElementById('gaugeMini').getContext('2d');
  charts.gaugeMini=new Chart(ctx,{type:'doughnut',data:{labels:['Counted','Remaining'],datasets:[{data:[totalCounted,Math.max(0,DAILY_TARGET-totalCounted)],backgroundColor:['#7dd3fc','#f97316']}]},options:{rotation:-Math.PI,circumference:Math.PI,plugins:{centerText:{text:totalCounted+'/'+DAILY_TARGET}}}});
  document.getElementById('gaugeCenterText').innerText=totalCounted+'/'+DAILY_TARGET;
  document.getElementById('gaugeBreakdown').innerText='Remaining: '+Math.max(0,DAILY_TARGET-totalCounted);
}

/* ---------- init ---------- */
loadAndRender();
</script>
</body>
</html>
