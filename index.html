<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VCB — Robust Professional Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#061227; --panel:#0b1724; --muted:#9aa4b2; --accentA:#7dd3fc; --accentB:#8b5cf6; --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Arial;background:linear-gradient(180deg,#031026,#061226);color:#eaf6ff}
header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px}
header h1{margin:0;font-size:20px}
.meta{color:var(--muted);font-size:13px;margin-top:6px}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--accentA);cursor:pointer;font-weight:700}
.primary{background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#021024;border:0}
.wrap{padding:12px 20px}
.grid{display:grid;grid-template-columns:360px 1fr 420px;gap:16px;align-items:start}
@media (max-width:1200px){ .grid{grid-template-columns:1fr; } .rightCol{order:3} .middleCol{order:2} .leftCol{order:1} }
.panel{background:var(--panel);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 30px rgba(2,6,23,0.45)}
.panel h3{margin:0 0 10px 0;font-size:15px}
.taskCard{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.02);margin-bottom:8px}
.taskName{font-weight:700;font-size:13px}
.taskNote{font-size:12px;color:var(--muted)}
.badge{padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px}
.badge.done{background:linear-gradient(90deg,#16a34a,#064e3b);color:white}
.badge.todo{background:linear-gradient(90deg,#7f1d1d,#ef4444);color:white}
.small{font-size:13px;color:var(--muted)}
.tableWrap{max-height:520px;overflow:auto}
table{width:100%;border-collapse:collapse;color:#eaf6ff;font-size:13px}
thead th{position:sticky;top:0;background:rgba(10,14,24,0.2);padding:8px;color:var(--muted);font-weight:700;text-align:left}
td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
.charts{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.chartCard{padding:8px;border-radius:10px;background:var(--glass);display:flex;flex-direction:column;min-height:280px}
.canvasWrap{flex:1;min-height:240px;display:flex;align-items:stretch}
canvas{width:100% !important; height:100% !important; display:block}
.controlsRow{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.note{color:var(--muted);font-size:12px;margin-top:6px}
.topControls{display:flex;gap:10px;align-items:center}
.select{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:#eaf6ff}
.kv{font-weight:700;color:#fff}
.smallMuted{color:var(--muted);font-size:12px}
.footerNote{color:var(--muted);font-size:12px;margin-top:12px}
</style>
</head>
<body>
  <header>
    <div>
      <h1>Stock Team VCB — Professional Dashboard</h1>
      <div class="meta" id="metaLine">Loading…</div>
    </div>
    <div class="controls topControls">
      <select id="scaleMode" class="select" title="Scaling mode">
        <option value="raw">Raw (no scaling)</option>
        <option value="scaled" selected>Scaled (auto)</option>
        <option value="log">Log scale (visual)</option>
      </select>
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="demoBtn" class="btn">Toggle Demo</button>
      <button id="exportCsv" class="btn primary">Export CSV</button>
      <button id="exportImage" class="btn">Save Image</button>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="panel leftCol">
        <h3>Daily tasks</h3>
        <div id="dailyList" style="max-height:340px;overflow:auto"></div>
        <h3 style="margin-top:12px">Weekly tasks</h3>
        <div id="weeklyList" style="max-height:260px;overflow:auto"></div>
        <div class="footerNote">Tip: folosește <span class="smallMuted">Refresh</span> după actualizarea JSON.</div>
      </div>

      <!-- MIDDLE -->
      <div class="panel middleCol">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3>PI Overview</h3>
            <div class="small" id="piSummary">Loading…</div>
          </div>
          <div class="small" id="lastUpdated">—</div>
        </div>

        <div style="height:12px"></div>

        <div class="charts">
          <div class="chartCard">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>Counted vs Total (per Area)</strong><div class="smallMuted">Bar chart — stacked</div></div>
              <div class="smallMuted">Scale: <span id="currentScale" class="kv">auto</span></div>
            </div>
            <div class="canvasWrap" style="min-height:300px">
              <canvas id="piBar" style="min-height:300px"></canvas>
            </div>
          </div>

          <div class="chartCard">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>Weekly Qty (by Week)</strong><div class="smallMuted">Aggregated per week number</div></div>
              <div class="smallMuted">Points: <span id="pointCount" class="kv">—</span></div>
            </div>
            <div class="canvasWrap" style="min-height:300px">
              <canvas id="weeklyLine" style="min-height:300px"></canvas>
            </div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="chartCard" style="display:flex;gap:12px;align-items:center;min-height:180px">
          <div style="width:220px;height:160px">
            <canvas id="tasksDonut" style="min-height:160px"></canvas>
          </div>
          <div>
            <div class="smallMuted">Tasks completion (Daily + Weekly)</div>
            <div id="tasksStats" style="margin-top:10px;font-weight:800;font-size:16px"></div>
            <div class="note">Green = completed, red = remaining / not started</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel rightCol">
        <h3>PI — Daily by Area (table)</h3>
        <div class="tableWrap">
          <table id="piTable">
            <thead><tr><th>Area</th><th style="text-align:right">Total</th><th style="text-align:right">Counted</th><th style="text-align:right">Behind target</th><th style="text-align:right">Behind %</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <h3 style="margin-top:12px">Weekly PI details</h3>
        <div class="tableWrap" style="max-height:200px;overflow:auto">
          <table id="weeklyPiTable">
            <thead><tr><th>Week</th><th>Area</th><th style="text-align:right">Daily Qty</th><th style="text-align:right">Weekly Qty</th><th style="text-align:right">Weekly %</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================== Utilities ================== */
function safeNum(v){
  if (v === null || v === undefined) return 0;
  if (typeof v === 'string') {
    const s = v.replace(/\s/g,'').replace(/,/g,'');
    const n = Number(s);
    return isFinite(n) ? n : 0;
  }
  if (typeof v === 'number') return isFinite(v)?v:0;
  return 0;
}

function findKey(obj, names){
  if (!obj) return undefined;
  if (!Array.isArray(names)) names = [names];
  const keys = Object.keys(obj);
  for (let n of names){
    for (let k of keys){
      if (k.trim().toLowerCase() === n.trim().toLowerCase()) return k;
    }
  }
  for (let n of names){
    for (let k of keys){
      if (k.trim().toLowerCase().indexOf(n.trim().toLowerCase()) !== -1) return k;
    }
  }
  return undefined;
}

// Excel serial -> ISO yyyy-mm-dd
function excelSerialToISO(serial){
  if (serial === null || serial === undefined) return '';
  if (typeof serial === 'string' && serial.indexOf('-') !== -1) return serial;
  const s = Number(serial) || 0;
  // Excel epoch: 1899-12-30 for JS conversion via days
  const ms = (s - 25569) * 86400 * 1000;
  const d = new Date(ms);
  const dt = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
  return dt.toISOString().slice(0,10);
}

function formatNumber(n){
  if (n === null || n === undefined) return '0';
  n = Number(n);
  if (!isFinite(n)) return String(n);
  if (Math.abs(n) >= 1e9) return (n/1e9).toFixed(2)+'B';
  if (Math.abs(n) >= 1e6) return (n/1e6).toFixed(2)+'M';
  if (Math.abs(n) >= 1e3) return (n/1e3).toFixed(1)+'K';
  return n.toString();
}

/* ================== Globals & Elements ================== */
let charts = { piBar:null, weeklyLine:null, tasksDonut:null };
let useDemo = false;
const refreshBtn = document.getElementById('refreshBtn');
const demoBtn = document.getElementById('demoBtn');
const scaleModeEl = document.getElementById('scaleMode');
const exportCsvBtn = document.getElementById('exportCsv');
const exportImageBtn = document.getElementById('exportImage');

refreshBtn.addEventListener('click', refresh);
demoBtn.addEventListener('click', ()=>{ useDemo = !useDemo; refresh(); });
scaleModeEl.addEventListener('change', ()=>{ refresh(); });
exportCsvBtn.addEventListener('click', exportCsv);
exportImageBtn.addEventListener('click', exportImage);

/* ================== Demo payload (fallback) ================== */
const demoPayload = {
  piData: [
    {"Date ":46010,"Area ":"MPR","Total locations":14622,"Counted ":3936,"Behind targe":0,"Above target":222.476,"Behind %":0},
    {"Date ":46010,"Area ":"PB1","Total locations":4329,"Counted ":1189,"Behind targe":0,"Above target":89.5714,"Behind %":0},
    {"Date ":46010,"Area ":"Total:","Total locations":137369,"Counted ":37994,"Behind targe":237.714,"Above target":3245.8095,"Behind %":0.00173}
  ],
  dailyTask: [
    {"DATE":46010,"Task ":"SHRINKAGE RECONCILATION DAILY","Status":"Not started","Type":"Daily"},
    {"DATE":46010,"Task ":"Aged stock report 7AM","Status":"Completed","Type":"Daily"}
  ],
  weeklyTask: [
    {"Date":46010,"Task":"(Weekly) SLA","Status":"Completed","Type":"Weekly"},
    {"Date":46010,"Task":"(Weekly) Shrinkage","Status":"Not started","Type":"Weekly"}
  ],
  weeklyPiData: [
    {"Date ":46010,"Area ":"MPR","Daily Qty":127,"Week No":32," Weekly Qty":4524," Weekly %":0.7584}
  ],
  meta: { today: new Date().toLocaleDateString(), rows: 42 }
};

/* ================== Fetch & Render ================== */
function refresh(){
  refreshBtn.disabled = true;
  refreshBtn.innerText = 'Refreshing…';
  if (useDemo){
    setTimeout(()=>{ render(demoPayload); refreshBtn.disabled=false; refreshBtn.innerText='Refresh'; }, 180);
    return;
  }
  fetch('./data/dashboard.json?_=' + Date.now())
    .then(r => {
      if (!r.ok) throw new Error('network response not ok ('+r.status+')');
      return r.json();
    })
    .then(payload => render(payload))
    .catch(err => {
      console.warn('Fetch failed — using demo payload', err);
      render(demoPayload);
    })
    .finally(()=>{ refreshBtn.disabled=false; refreshBtn.innerText='Refresh'; });
}

function render(payload){
  try {
    if (!payload) { console.error('no payload'); return; }
    // meta
    const todayStr = payload.meta && payload.meta.today ? payload.meta.today : new Date().toLocaleDateString();
    document.getElementById('metaLine').innerText = 'Live • ' + todayStr + ' • rows: ' + (payload.meta?.rows || '—');
    document.getElementById('lastUpdated').innerText = new Date().toLocaleString();

    // tasks
    renderTasks(payload.dailyTask || [], 'dailyList');
    renderTasks(payload.weeklyTask || [], 'weeklyList');

    // PI
    renderPI(payload.piData || []);
    renderWeeklyPI(payload.weeklyPiData || []);

    // tasks donut
    renderTasksDonut(payload.dailyTask || [], payload.weeklyTask || []);
  } catch (e) {
    console.error('render error', e);
  }
}

/* ================== Tasks ================== */
function renderTasks(list, containerId){
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  if (!Array.isArray(list) || list.length === 0){
    el.innerHTML = '<div class="smallMuted" style="padding:8px">No tasks</div>';
    return;
  }
  // sort: not completed first
  list.sort((a,b)=>{
    const sa = String(a.Status||'').toLowerCase(), sb = String(b.Status||'').toLowerCase();
    const aDone = sa.includes('complete') || sa.includes('done');
    const bDone = sb.includes('complete') || sb.includes('done');
    if (aDone && !bDone) return 1;
    if (bDone && !aDone) return -1;
    return 0;
  });
  list.forEach(item=>{
    const nameKey = findKey(item, ['Task ','Task','task']);
    const name = nameKey ? item[nameKey] : JSON.stringify(item).slice(0,60);
    const status = item.Status || item['Status '] || '';
    const done = String(status).toLowerCase().includes('complete') || String(status).toLowerCase().includes('done');
    const card = document.createElement('div');
    card.className = 'taskCard';
    card.innerHTML = `<div style="max-width:72%"><div class="taskName">${escapeHtml(name)}</div><div class="taskNote">${escapeHtml(status || '')}</div></div>
      <div><div class="badge ${done ? 'done' : 'todo'}">${done ? 'Done' : 'To do'}</div></div>`;
    el.appendChild(card);
  });
}

/* ================== PI Rendering & Charts ================== */

function renderPI(piList){
  // normalize keys and rows
  const rows = Array.isArray(piList) ? piList.slice() : [];
  if (rows.length === 0){
    document.querySelector('#piTable tbody').innerHTML = '<tr><td colspan="5" class="smallMuted">No PI data</td></tr>';
    if (charts.piBar){ charts.piBar.destroy(); charts.piBar = null; }
    return;
  }

  const areaKey = findKey(rows[0], ['Area','Area ']);
  const totalKey = findKey(rows[0], ['Total locations','Total locations ','Total','Total locations']);
  const countedKey = findKey(rows[0], ['Counted','Counted ']);
  const behindKey = findKey(rows[0], ['Behind %','Behind % ','Behind targe','Behind target']);
  const behindRawKey = findKey(rows[0], ['Behind targe','Behind target','Behind targe ']);

  const data = [];
  rows.forEach(r=>{
    const area = String(r[areaKey] || r['Area'] || '').trim();
    if (!area) return;
    // skip totals row
    if (String(area).toLowerCase().indexOf('total') !== -1) return;
    const total = safeNum(r[totalKey] || r['Total locations'] || r['Total locations '] || 0);
    const counted = Math.min(safeNum(r[countedKey] || r['Counted '] || 0), total);
    const behindRaw = safeNum(r[behindRawKey] || r['Behind targe'] || 0);
    // behind percent may be fraction like 0.0017 or percent-like
    let behindPct = safeNum(r[behindKey] || r['Behind %'] || 0);
    if (behindPct <= 1 && behindPct > 0.0001) behindPct = behindPct * 100;
    data.push({ area, total, counted, behindRaw, behindPct });
  });

  // fill table
  const tbody = document.querySelector('#piTable tbody'); tbody.innerHTML = '';
  let totalSum=0, countedSum=0;
  data.forEach(r=>{
    totalSum += r.total; countedSum += r.counted;
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${escapeHtml(r.area)}</td>
      <td style="text-align:right">${formatNumber(r.total)}</td>
      <td style="text-align:right">${formatNumber(r.counted)}</td>
      <td style="text-align:right">${formatNumber(r.behindRaw)}</td>
      <td style="text-align:right">${Number(r.behindPct||0).toFixed(2)}%</td>
    </tr>`);
  });
  document.getElementById('piSummary').innerText = `Locations: ${totalSum.toLocaleString()} • Counted: ${countedSum.toLocaleString()} • Coverage: ${((countedSum/Math.max(1,totalSum))*100).toFixed(2)}%`;

  // prepare chart dataset
  let labels = data.map(d=>d.area);
  let countedDs = data.map(d=>d.counted);
  let totalDs = data.map(d=>d.total);

  // guard: if all zeros -> add tiny values
  if (totalDs.every(v=>v===0) && countedDs.every(v=>v===0)) {
    labels = ['No data']; countedDs = [1]; totalDs = [1];
  }

  // scaling mode
  const mode = scaleModeEl.value || 'scaled';
  document.getElementById('currentScale').innerText = mode;

  // compute scale to avoid extreme bars
  let scaleFactor = 1;
  const maxVal = Math.max(...totalDs, 1);
  if (mode === 'scaled'){
    // auto scale: reduce magnitudes > 10000
    if (maxVal > 50000) scaleFactor = 0.001; // thousands -> millions safe
    else if (maxVal > 20000) scaleFactor = 0.01;
    else if (maxVal > 5000) scaleFactor = 0.1;
    else scaleFactor = 1;
  } else if (mode === 'log'){
    // log transform values for visualization (avoid negative/zero)
    // Chart.js can accept transformed values directly
    countedDs = countedDs.map(v => Math.log10( Math.max(1, v) ));
    totalDs = totalDs.map(v => Math.log10( Math.max(1, v) ));
  } // raw uses as-is

  if (mode !== 'log' && scaleFactor !== 1){
    countedDs = countedDs.map(v => Number((v * scaleFactor).toFixed(3)));
    totalDs = totalDs.map(v => Number((v * scaleFactor).toFixed(3)));
  }

  // destroy old
  try { if (charts.piBar) charts.piBar.destroy(); } catch(e){ console.warn(e); charts.piBar = null; }

  // Limit labels if too many
  const maxLabels = 40;
  let labelsForChart = labels.slice();
  let countedForChart = countedDs.slice();
  let totalForChart = totalDs.slice();
  if (labels.length > maxLabels){
    // pick top N by total
    const idxs = totalDs.map((v,i)=>({v,i})).sort((a,b)=>b.v-a.v).slice(0,maxLabels).map(x=>x.i).sort((a,b)=>a-b);
    labelsForChart = idxs.map(i=>labels[i]);
    countedForChart = idxs.map(i=>countedDs[i]);
    totalForChart = idxs.map(i=>totalDs[i]);
  }

  // create stacked bar
  const ctx = document.getElementById('piBar').getContext('2d');
  charts.piBar = new Chart(ctx, {
    type:'bar',
    data:{
      labels: labelsForChart,
      datasets:[
        { label:'Counted', data: countedForChart, backgroundColor:'rgba(125,211,252,0.95)', stack:'s' },
        { label:'Remaining', data: totalForChart.map((t,i)=>Math.max(0,t - (countedForChart[i]||0))), backgroundColor:'rgba(139,92,246,0.16)', stack:'s' }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{position:'top'}, tooltip:{mode:'index', intersect:false}},
      scales:{
        x:{ticks:{color:'#cfeeff'}, grid:{display:false}},
        y:{
          beginAtZero:true,
          ticks:{color:'#cfeeff', callback: function(val){ return formatNumber(val); }},
          title:{display:false}
        }
      },
      interaction:{mode:'nearest', axis:'x', intersect:false}
    }
  });
}

/* ================== Weekly PI ================== */
function renderWeeklyPI(weeklyList){
  const tbody = document.querySelector('#weeklyPiTable tbody'); tbody.innerHTML = '';
  const arr = Array.isArray(weeklyList) ? weeklyList.slice() : [];

  if (!arr.length){
    tbody.innerHTML = '<tr><td colspan="5" class="smallMuted">No weekly PI data</td></tr>';
    if (charts.weeklyLine){ charts.weeklyLine.destroy(); charts.weeklyLine = null; document.getElementById('pointCount').innerText = '0'; }
    return;
  }

  // identify keys robustly
  const areaKey = findKey(arr[0], ['Area','Area ']);
  const weekKey = findKey(arr[0], ['Week No','WeekNo','Week No','Week']);
  const dailyKey = findKey(arr[0], ['Daily Qty','DailyQty','Daily']);
  const weeklyQtyKey = findKey(arr[0], [' Weekly Qty','Weekly Qty',' Weekly Qty']);

  // append rows and aggregate
  const agg = {};
  arr.forEach(r=>{
    const area = r[areaKey] || r['Area'] || '';
    const week = r[weekKey] || r['Week No'] || r['Week'] || '';
    const dailyQty = safeNum(r[dailyKey] || 0);
    const weeklyQty = safeNum(r[weeklyQtyKey] || r[' Weekly Qty'] || 0);
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${escapeHtml(week)}</td><td>${escapeHtml(area)}</td><td style="text-align:right">${formatNumber(dailyQty)}</td><td style="text-align:right">${formatNumber(weeklyQty)}</td><td style="text-align:right">${(safeNum(r[' Weekly %']||r['Weekly %']||0)*100).toFixed(3)}%</td>
    </tr>`);
    const wk = String(week);
    agg[wk] = (agg[wk] || 0) + weeklyQty;
  });

  // create sorted weekly arrays
  const weekKeys = Object.keys(agg).map(k=>Number(k)).filter(n=>!isNaN(n)).sort((a,b)=>a-b);
  if (weekKeys.length === 0){
    // fallback if non-numeric weeks: keep original order unique
    const uniq = Array.from(new Set(Object.keys(agg)));
    weekKeys.splice(0, weekKeys.length, ...uniq);
  }
  const labels = weekKeys.map(String);
  const values = weekKeys.map(k=>agg[k]);

  document.getElementById('pointCount').innerText = labels.length;

  try { if (charts.weeklyLine) charts.weeklyLine.destroy(); } catch(e){ charts.weeklyLine = null; }

  // transform for scale mode
  const mode = scaleModeEl.value || 'scaled';
  let valuesForChart = values.map(v => Number(v));
  if (mode === 'log') valuesForChart = valuesForChart.map(v => Math.log10(Math.max(1,v)));
  else if (mode === 'scaled'){
    const maxVal = Math.max(...valuesForChart,1);
    if (maxVal > 50000) valuesForChart = valuesForChart.map(v => v * 0.001);
    else if (maxVal > 20000) valuesForChart = valuesForChart.map(v => v * 0.01);
  }
  const ctx = document.getElementById('weeklyLine').getContext('2d');
  charts.weeklyLine = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{ label:'Weekly Qty', data: valuesForChart, borderColor:'rgba(125,211,252,0.95)', backgroundColor:'rgba(125,211,252,0.08)', fill:true, tension:0.25, pointRadius:3 }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ x:{ticks:{color:'#cfeeff'}}, y:{ticks:{color:'#cfeeff', callback:function(v){ return formatNumber(v); }}} }
  });
}

/* ================== Tasks donut ================== */
function renderTasksDonut(daily, weekly){
  const merged = (Array.isArray(daily)?daily:[]).concat(Array.isArray(weekly)?weekly:[]);
  let done = 0, todo = 0;
  merged.forEach(t=>{
    const s = String(t.Status || t['Status '] || '').toLowerCase();
    if (s.includes('complete') || s.includes('done')) done++; else todo++;
  });
  document.getElementById('tasksStats').innerText = `Completed ${done} • Remaining ${todo}`;

  try { if (charts.tasksDonut) charts.tasksDonut.destroy(); } catch(e){ charts.tasksDonut = null; }

  const ctx = document.getElementById('tasksDonut').getContext('2d');
  charts.tasksDonut = new Chart(ctx, {
    type:'doughnut',
    data:{ labels:['Done','Remaining'], datasets:[{ data:[done,todo], backgroundColor:['rgba(139,92,246,0.98)','rgba(125,211,252,0.14)'] }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
  });
}

/* ================== Export functions ================== */
function exportCsv(){
  // export PI table
  const rows = [];
  rows.push(['Area','Total','Counted','Behind raw','Behind %']);
  document.querySelectorAll('#piTable tbody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    if (!tds.length) return;
    const row = [];
    tds.forEach(td => row.push(td.innerText.replace(/,/g,'')));
    rows.push(row);
  });
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'pi_by_area.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function exportImage(){
  // combine main charts into a single image by exporting canvases separately (simple approach: open each in new tab)
  // We'll trigger downloads of each chart as PNG
  const map = { 'piBar':'pi-bar.png', 'weeklyLine':'weekly-line.png', 'tasksDonut':'tasks-donut.png' };
  for (const id in map){
    const canvas = document.getElementById(id === 'tasksDonut' ? 'tasksDonut' : (id === 'piBar' ? 'piBar' : 'weeklyLine'));
    if (!canvas) continue;
    try {
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a'); a.href = url; a.download = map[id]; document.body.appendChild(a); a.click(); a.remove();
    } catch(e){ console.warn('Export image failed', e); }
  }
}

/* ================== Helpers ================== */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ================== Init ================== */
refresh();

</script>
</body>
</html>
