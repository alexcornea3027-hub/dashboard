<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Team | 3D Mission Control</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

<script async src="https://ga.jspm.io/npm:es-module-shims@1.8.1/dist/es-module-shims.js"></script>
<script type="importmap-shim">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
    "three/": "https://cdn.jsdelivr.net/npm/three@0.158.0/"
  }
}
</script>

<style>
:root{
 --bg:#f9f5f0; --panel:#fff; --text:#1f2937;
 --soft1:#cbb6ff; --soft2:#ffd7b5; --soft3:#ffe58a; --accent:#a78bfa;
 --particle:#f6a5c0; --glass:rgba(31,41,55,0.04); --border:rgba(31,41,55,0.06);
}
[data-theme="dark"]{
 --bg:#0b0f14; --panel:#0f1720; --text:#e6eef8;
 --soft1:#7b61ff; --soft2:#ffb27a; --soft3:#ffcf5c; --accent:#b794ff;
 --particle:#ff92b0; --glass: rgba(255,255,255,0.03); --border: rgba(255,255,255,0.06);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;}
.app{display:grid;grid-template-rows:70px 110px 1fr;gap:12px;padding:12px;height:100vh;}
.header{display:flex;justify-content:space-between;align-items:center;padding:0 18px;}
.brand{font-weight:800;font-size:1.2rem;}
.brand span{color:var(--soft3);}
.controls{display:flex;gap:6px;}
.small{padding:6px 12px;border-radius:10px;background:transparent;border:1px solid var(--border);cursor:pointer;color:var(--text);}
.clock{display:flex;justify-content:center;align-items:center;}
.clock-card{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:70px;background:var(--panel);border:1px solid var(--border);box-shadow:0 10px 24px rgba(0,0,0,0.04);}
#time{font-size:1.6rem;font-weight:800;letter-spacing:2px;}
#date{font-size:.85rem;color:var(--text);}
.main{display:grid;grid-template-columns:1.6fr 1fr;grid-template-rows:1fr 1fr;gap:12px;padding:6px;}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;position:relative;overflow:hidden;min-height:140px;}
.title{font-size:.82rem;color:var(--text);letter-spacing:1.2px;margin-bottom:8px;}
.canvas{width:100%;height:100%;min-height:160px;}
.tasks{height:100%;overflow:auto;padding-right:8px;max-height:520px;}
.task{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:12px;background:var(--glass);margin-bottom:8px;}
.done{border-left:4px solid var(--accent);}
.badge{padding:6px 12px;border-radius:999px;font-weight:800;font-size:.75rem;}
.ok{background:var(--accent);color:#fff;}
.wait{background:#e2e8f0;color:var(--text);}
.tooltip{position:fixed;pointer-events:none;padding:10px 14px;border-radius:10px;background:rgba(0,0,0,0.78);color:#fff;z-index:9999;display:none;transform:translate(-50%,-120%);font-weight:700;}
.labels-row{display:flex;justify-content:center;gap:18px;margin-top:6px;flex-wrap:wrap;color:var(--text);font-weight:700;}
</style>
</head>
<body data-theme="light">

<div class="app">
 <div class="header">
   <div class="brand">STOCK TEAM <span>| VCB</span></div>
   <div class="controls">
     <button id="themeBtn" class="small">Toggle Theme</button>
     <button id="fsBtn" class="small">Fullscreen</button>
     <button id="reloadBtn" class="small">Reload Data</button>
   </div>
 </div>

 <div class="clock">
   <div class="clock-card">
     <div id="hourglass" class="canvas" style="width:100px;height:100px"></div>
     <div>
       <div id="time">00:00:00</div>
       <div id="date">Loading…</div>
     </div>
   </div>
 </div>

 <div class="main">
   <div class="card" style="grid-row:span 2">
     <div class="title">Weekly Volume · 3D Waterfall + Particles</div>
     <div id="weekly3d" class="canvas"></div>
     <div class="labels-row" id="weekLabels"></div>
   </div>

   <div class="card">
     <div class="title">Counting Progress · 3D Donut + Mini Charts</div>
     <div id="donut3d" class="canvas"></div>
     <div style="margin-top:12px">
       <canvas id="miniLine" height="80"></canvas>
       <canvas id="miniDoughnut" height="80"></canvas>
     </div>
   </div>

   <div class="card">
     <div class="title">Daily & Weekly Tasks</div>
     <div style="display:flex;gap:12px">
       <div style="flex:1">
         <h4 style="color:var(--text);margin-bottom:6px">Daily</h4>
         <div class="tasks" id="dailyTasks"></div>
       </div>
       <div style="flex:1">
         <h4 style="color:var(--text);margin-bottom:6px">Weekly</h4>
         <div class="tasks" id="weeklyTasks"></div>
       </div>
     </div>
   </div>
 </div>
</div>
<div id="tooltip" class="tooltip"></div>

<script type="module-shim">
import * as THREE from "three";
import {OrbitControls} from "three/examples/jsm/controls/OrbitControls.js";

/* ------------------------
   UTILS
------------------------*/
function safeParseJSON(txt){
  if(!txt) return null;
  txt = txt.trim();
  if(txt.charCodeAt(0)===0xFEFF) txt=txt.slice(1);
  return JSON.parse(txt);
}
async function loadJSON(path){
  try{
    const r=await fetch(path,{cache:'no-cache'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const txt=await r.text();
    return safeParseJSON(txt);
  }catch(e){ console.warn('JSON load failed — using fallback defaults',e); return null; }
}

/* ------------------------
   TASKS RENDER
------------------------*/
function renderTasks(daily,weekly){
  const dailyEl=document.getElementById('dailyTasks');
  const weeklyEl=document.getElementById('weeklyTasks');
  dailyEl.innerHTML=''; weeklyEl.innerHTML='';
  daily.forEach(t=>{
    const div=document.createElement('div'); div.className=`task ${t.status==='Completed'?'done':''}`;
    div.innerHTML=`<span>${t.name}</span><span class="badge ${t.status==='Completed'?'ok':'wait'}">${t.status==='Completed'?'READY':'PENDING'}</span>`;
    dailyEl.appendChild(div);
  });
  weekly.forEach(t=>{
    const div=document.createElement('div'); div.className=`task ${t.status==='Completed'?'done':''}`;
    div.innerHTML=`<span>${t.name}</span><span class="badge ${t.status==='Completed'?'ok':'wait'}">${t.status==='Completed'?'READY':'PENDING'}</span>`;
    weeklyEl.appendChild(div);
  });
}

/* ------------------------
   CLOCK
------------------------*/
setInterval(()=>{
  const d=new Date();
  document.getElementById('time').innerText=d.toLocaleTimeString('en-GB',{hour12:false});
  document.getElementById('date').innerText=d.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long'});
},1000);

/* ------------------------
   WEEKLY 3D CHART
------------------------*/
let weeklyScene,weeklyCamera,weeklyRenderer,weeklyBars=[];
async function createWeekly3D(history){
  const container=document.getElementById('weekly3d');
  weeklyScene=new THREE.Scene();
  weeklyCamera=new THREE.PerspectiveCamera(50, container.clientWidth/container.clientHeight,0.1,100);
  weeklyCamera.position.set(0,12,20);

  weeklyRenderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
  weeklyRenderer.setSize(container.clientWidth,container.clientHeight);
  container.appendChild(weeklyRenderer.domElement);

  weeklyScene.add(new THREE.AmbientLight(0xffffff,0.5));
  const dir=new THREE.DirectionalLight(0xffffff,0.7); dir.position.set(5,12,10); weeklyScene.add(dir);

  const values=history.map(h=>Number(h.total||0));
  const labels=history.map(h=>h.week||'');
  const max=Math.max(...values,1);
  weeklyBars=[];

  values.forEach((v,i)=>{
    const h=(v/max)*7+0.4;
    const mat=new THREE.MeshStandardMaterial({color:0xffb703});
    const box=new THREE.Mesh(new THREE.BoxGeometry(1.4,h,1.2),mat);
    box.position.set((i-(values.length-1)/2)*2.2,h/2,0);
    weeklyScene.add(box);
    weeklyBars.push({mesh:box,height:h,value:v,label:labels[i]});
  });

  // labels
  const labelsEl=document.getElementById('weekLabels'); labelsEl.innerHTML='';
  labels.forEach(l=>{
    const el=document.createElement('div'); el.innerText=l; labelsEl.appendChild(el);
  });

  const controls=new OrbitControls(weeklyCamera,weeklyRenderer.domElement);
  controls.enableDamping=true;
  function animate(){
    requestAnimationFrame(animate);
    weeklyBars.forEach(b=>{ b.mesh.position.y += (b.height/2-b.mesh.position.y)*0.05; });
    weeklyCamera.position.x=12*Math.sin(Date.now()*0.001);
    weeklyCamera.position.z=12*Math.cos(Date.now()*0.001);
    weeklyCamera.lookAt(0,3,0);
    controls.update();
    weeklyRenderer.render(weeklyScene,weeklyCamera);
  }
  animate();
}

/* ------------------------
   INIT
------------------------*/
async function init(){
  const data=await loadJSON('data/dashboard.json') || {
    metadata:{target:1193,timestamp:'--'},
    counting:[{area:'MPR',qty:14622},{area:'PB1',qty:4329}],
    dailyTasks:[{name:'Aged stock report 7AM',status:'Completed'}],
    weeklyTasks:[{name:'(Weekly) SLA',status:'Not started'}],
    history:[{week:'W32',total:6901},{week:'W33',total:5447}]
  };
  renderTasks(data.dailyTasks,data.weeklyTasks);
  createWeekly3D(data.history);
}
init();

/* ------------------------
   CONTROLS
------------------------*/
document.getElementById('themeBtn').addEventListener('click',()=>{ 
  document.body.dataset.theme=document.body.dataset.theme==='dark'?'light':'dark';
});
document.getElementById('fsBtn').addEventListener('click',()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen();
});
document.getElementById('reloadBtn').addEventListener('click',()=>init());
</script>
</body>
</html>
