<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VCB StockTeam — Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg: #fff7ed;
  --card: rgba(255,255,255,0.85);
  --accent: #ff7a18;
  --accent2: #ffb347;
  --text: #1f2937;
  --ok: #16a34a;
  --pending: #f59e0b;
  --danger: #ef4444;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(120deg,var(--bg),#ffe7d6);color:var(--text);overflow:hidden}
.header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px}
.header h1{margin:0;font-size:1.25rem}
.button{border:none;padding:8px 12px;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
.container{display:grid;grid-template-columns:1.45fr .75fr;gap:20px;padding:12px 20px;height:calc(100vh - 64px)}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,0.07);display:flex;flex-direction:column}
.top-clock{display:flex;align-items:center;justify-content:space-between;gap:12px}
.clock-box{display:flex;flex-direction:column;gap:6px}
.big-clock{font-size:2.5rem;font-weight:800;line-height:1}
.small-date{font-size:0.95rem;opacity:0.85}
.hourglass-wrap{width:56px;height:56px;display:flex;align-items:center;justify-content:center}
.hourglass{width:56px;height:56px;display:block;transition:transform .9s ease}
.hourglass.animate{animation:flip 900ms ease}
@keyframes flip{0%{transform:rotate(0) scale(1)}50%{transform:rotate(180deg) scale(1.04)}100%{transform:rotate(360deg) scale(1)}}

/* charts grid & sizes */
.charts-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-top:12px}
.canvas-fixed{height:220px}
.fullwidth-chart{height:200px;margin-top:12px}
.history-chart{height:150px;margin-top:12px}

/* sidebar */
.sidebar .meta{display:flex;justify-content:space-between;padding:8px 0;font-weight:700}
.counts{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.count-row{display:flex;justify-content:space-between;font-weight:700;padding:6px 0;border-bottom:1px dashed rgba(0,0,0,0.06)}
.tasks{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.tasks .list{overflow:auto;padding-right:6px}
.list .task{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);background:rgba(255,255,255,0.6);margin-bottom:6px}
.badge{padding:6px 10px;border-radius:999px;font-size:0.78rem;font-weight:800;color:#fff}
.completed{background:var(--ok)}
.pending{background:var(--pending)}
.under{background:var(--danger)}

/* progress */
.progress-wrap{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.progress-bar{height:14px;background:rgba(0,0,0,0.06);border-radius:999px;overflow:hidden}
.progress-bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}
.progress-labels{display:flex;justify-content:space-between;font-weight:800}

/* canvas sizing */
canvas{width:100% !important;height:100% !important}

/* only lists scroll */
.container > div, .card{overflow:hidden}

/* responsive */
@media (max-width:980px){
  .container{grid-template-columns:1fr;overflow:auto;height:auto;padding-bottom:40px}
  html,body{overflow:auto}
}
</style>
</head>
<body>
  <div class="header">
    <h1>VCB StockTeam Dashboard</h1>
    <div>
      <button class="button" onclick="toggleFull()">Fullscreen</button>
    </div>
  </div>

  <div class="container">
    <!-- LEFT -->
    <div style="display:flex;flex-direction:column;gap:12px">
      <div class="card top-clock">
        <div class="clock-box">
          <div class="big-clock" id="clock">--:--:--</div>
          <div class="small-date" id="date">—</div>
          <div class="small-date" id="tz">—</div>
        </div>
        <div class="hourglass-wrap" title="hourglass">
          <svg id="hourglass" class="hourglass" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden>
            <g fill="none" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 2h12"/>
              <path d="M6 22h12"/>
              <path d="M8 2s4.5 6 4 8-4 8-4 8"/>
              <path d="M16 22s-4.5-6-4-8 4-8 4-8"/>
              <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
            </g>
          </svg>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px 0">Daily — total vs Target</h3>
        <div class="progress-wrap">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Today: <span id="dailyTotal">0</span></div>
            <div style="font-weight:800">Target: <span id="targetDisplay">1193</span></div>
          </div>
          <div class="progress-bar"><i id="progressFill" style="width:0%"></i></div>
          <div class="progress-labels"><div id="pctLabel">0%</div><div id="statusLabel">Under target</div></div>
        </div>

        <div style="margin-top:12px">
          <h4 style="margin:8px 0">Breakdown (by area)</h4>
          <div id="countsList" class="counts"></div>
        </div>
      </div>

      <div class="card charts-grid">
        <div>
          <h3 style="margin:0 0 8px 0">Daily Tasks Completion</h3>
          <div class="canvas-fixed"><canvas id="dailyChart"></canvas></div>
        </div>
        <div>
          <h3 style="margin:0 0 8px 0">Weekly Tasks Completion</h3>
          <div class="canvas-fixed"><canvas id="weeklyChart"></canvas></div>
        </div>
      </div>

      <div class="card fullwidth-chart">
        <h3 style="margin:0 0 8px 0">Inventory by Area</h3>
        <canvas id="inventoryChart" style="height:100%"></canvas>
      </div>

      <div class="card history-chart">
        <h3 style="margin:0 0 8px 0">Weekly History (totals)</h3>
        <canvas id="historyChart" style="height:100%"></canvas>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="sidebar" style="display:flex;flex-direction:column;gap:12px">
      <div class="card">
        <h3 style="margin:0 0 8px 0">Metadata</h3>
        <div class="meta"><span>Target</span><span id="metaTarget">1193</span></div>
        <div class="meta"><span>Timestamp</span><span id="timestamp">-</span></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Counts</h3>
        <div id="counts" class="counts"></div>
      </div>

      <div class="card tasks">
        <h3 style="margin:0 0 8px 0">Daily Tasks</h3>
        <div id="dailyTasks" class="list" style="max-height:220px"></div>
      </div>

      <div class="card tasks">
        <h3 style="margin:0 0 8px 0">Weekly Tasks</h3>
        <div id="weeklyTasks" class="list" style="max-height:220px"></div>
      </div>
    </div>
  </div>

<script>
/* ---------- Fullscreen utility ---------- */
function toggleFull(){
  if(!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
}

/* ---------- Clock + hourglass animation ---------- */
let lastMinute = null;
function updateClock(){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const ss = String(now.getSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent = `${hh}:${mm}:${ss}`;
  document.getElementById('date').textContent = now.toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'short', day:'numeric' });
  document.getElementById('tz').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone || '';

  if (lastMinute === null) lastMinute = now.getMinutes();
  if (now.getMinutes() !== lastMinute) {
    lastMinute = now.getMinutes();
    const hg = document.getElementById('hourglass');
    hg.classList.remove('animate');
    void hg.offsetWidth;
    hg.classList.add('animate');
  }
}
setInterval(updateClock, 1000);
updateClock();

/* ---------- Data loader ---------- */
async function loadData(){
  let data = null;
  try {
    const res = await fetch('data/dashboard.json', {cache: "no-store"});
    if (!res.ok) throw new Error('no file');
    data = await res.json();
  } catch (e) {
    // fallback sample (the JSON you pasted) — used for testing if data/dashboard.json missing
    data = {
      "metadata": { "target": 1193, "timestamp": (new Date()).toISOString() },
      "counting": [
        { "area": "MPR", "qty": 27 },{ "area": "PB1", "qty": 28 },{ "area": "PB2", "qty": 29 },
        { "area": "PB3", "qty": 30 },{ "area": "PB4", "qty": 31 },{ "area": "PBSRES", "qty": 32 },
        { "area": "MP", "qty": 33 },{ "area": "MIX", "qty": 34 },{ "area": "MS", "qty": 35 },
        { "area": "MSX", "qty": 36 },{ "area": "FM", "qty": 37 },{ "area": "HP", "qty": 38 }
      ],
      "dailyTasks": [
        { "name": "ADJUSTMENTS (Returns)", "status": "Not started" },
        { "name": "ADJUSTMENTS (Standard)", "status": "Not started" },
        { "name": "Aged stock report 7AM", "status": "Completed" },
        { "name": "Aged stock report 3PM", "status": "Not started" }
      ],
      "weeklyTasks": [
        { "name": "(Weekly) SLA", "status": "Not started" },
        { "name": "(Weekly) SIS report", "status": "Not started" },
        { "name": "(once a month) Shrinkage for Period", "status": "Completed" }
      ],
      "history": [
        { "week": "127", "total": 5103 },{ "week": "38", "total": 6457 },{ "week": "15", "total": 7494 }
      ]
    };
    console.warn('Using fallback demo data because data/dashboard.json could not be fetched.');
  }

  // metadata
  const target = (data && data.metadata && Number(data.metadata.target)) ? Number(data.metadata.target) : 1193;
  document.getElementById('metaTarget').textContent = target;
  document.getElementById('timestamp').textContent = data.metadata && data.metadata.timestamp ? data.metadata.timestamp : '-';
  document.getElementById('targetDisplay').textContent = target;

  // counts list
  const countsEl = document.getElementById('counts');
  countsEl.innerHTML = '';
  (data.counting || []).forEach(c => {
    const d = document.createElement('div');
    d.className = 'count-row';
    d.innerHTML = `<span>${c.area}</span><span>${c.qty}</span>`;
    countsEl.appendChild(d);
  });

  // daily total vs target
  const dailyTotal = (data.counting || []).reduce((s, it) => s + (Number(it.qty) || 0), 0);
  document.getElementById('dailyTotal').textContent = dailyTotal;
  const pct = Math.round((dailyTotal / (target || 1)) * 100);
  const pctClamp = Math.max(0, Math.min(200, pct));
  document.getElementById('progressFill').style.width = pctClamp + '%';
  document.getElementById('pctLabel').textContent = (pct >= 0 ? pct : 0) + '%';
  const statusLabel = document.getElementById('statusLabel');
  if (dailyTotal >= target) {
    statusLabel.textContent = 'Completed';
    statusLabel.style.color = 'var(--ok)';
  } else {
    statusLabel.textContent = 'Under target';
    statusLabel.style.color = 'var(--pending)';
  }

  // counts breakdown (detailed)
  const countsList = document.getElementById('countsList');
  countsList.innerHTML = '';
  (data.counting || []).forEach(c => {
    const row = document.createElement('div');
    row.className = 'count-row';
    row.innerHTML = `<span>${c.area}</span><span>${c.qty}</span>`;
    countsList.appendChild(row);
  });

  // render tasks lists
  const renderTasks = (elId, list) => {
    const el = document.getElementById(elId);
    el.innerHTML = '';
    (list || []).forEach(t => {
      const s = (String(t.status || '').toLowerCase().includes('completed') || String(t.status || '').toLowerCase().includes('done')) ? 'completed' : 'pending';
      const div = document.createElement('div');
      div.className = 'task';
      const badge = `<span class="badge ${s}">${t.status || ''}</span>`;
      div.innerHTML = `<span style="flex:1;padding-right:8px">${t.name}</span><span>${badge}</span>`;
      el.appendChild(div);
    });
  };

  renderTasks('dailyTasks', data.dailyTasks || []);
  renderTasks('weeklyTasks', data.weeklyTasks || []);

  // charts
  const countStatus = (list) => {
    const completed = (list || []).filter(t => String(t.status || '').toLowerCase().includes('completed') || String(t.status || '').toLowerCase().includes('done')).length;
    const pending = (list || []).length - completed;
    return [completed, pending];
  };

  // Daily doughnut
  const dailyCtx = document.getElementById('dailyChart').getContext('2d');
  if (window._dailyChart instanceof Chart) window._dailyChart.destroy();
  window._dailyChart = new Chart(dailyCtx, {
    type: 'doughnut',
    data: {
      labels: ['Completed','Pending'],
      datasets:[{ data: countStatus(data.dailyTasks || []), backgroundColor: ['#16a34a', '#f59e0b'] }]
    },
    options: { plugins:{legend:{position:'bottom'}} }
  });

  // Weekly doughnut
  const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
  if (window._weeklyChart instanceof Chart) window._weeklyChart.destroy();
  window._weeklyChart = new Chart(weeklyCtx, {
    type: 'doughnut',
    data: { labels:['Completed','Pending'], datasets:[{ data: countStatus(data.weeklyTasks || []), backgroundColor:['#16a34a','#f59e0b'] }] },
    options:{ plugins:{legend:{position:'bottom'}} }
  });

  // Inventory bar
  const invCtx = document.getElementById('inventoryChart').getContext('2d');
  if (window._invChart instanceof Chart) window._invChart.destroy();
  window._invChart = new Chart(invCtx, {
    type:'bar',
    data:{
      labels: (data.counting || []).map(c=>c.area),
      datasets:[{ label:'Qty', data:(data.counting || []).map(c=>c.qty), backgroundColor: (function(){ return (function(){ return Array.from({length:(data.counting||[]).length}, ()=>getComputedStyle(document.documentElement).getPropertyValue('--accent2')||'#ffb347'); })() })() }]
    },
    options:{animation:{duration:900}, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });

  // History line
  const histCtx = document.getElementById('historyChart').getContext('2d');
  if (window._histChart instanceof Chart) window._histChart.destroy();
  window._histChart = new Chart(histCtx, {
    type:'line',
    data:{
      labels: (data.history || []).map(h=>h.week),
      datasets:[{ label:'Total', data:(data.history || []).map(h=>h.total), borderColor:getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#ff7a18', tension:0.35, fill:false }]
    },
    options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:false}}}
  });
}

loadData();
</script>
</body>
</html>
