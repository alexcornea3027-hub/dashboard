<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock Team VCB</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#071022; --card:#071827; --muted:#9aa4b2;
  --accentA:#7dd3fc; --accentB:#8b5cf6; --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Arial;background:linear-gradient(180deg,#021026,#05122a);color:#eaf6ff}
.header{display:flex;justify-content:space-between;align-items:center;padding:18px 28px}
.brand{display:flex;flex-direction:column}
.brand h1{margin:0;font-size:22px;letter-spacing:0.6px}
.brand .sub{font-size:13px;color:var(--muted);margin-top:6px}
.controls{display:flex;gap:10px;align-items:center}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--accentA);cursor:pointer;font-weight:700}
.btn.primary{background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#021024;border:0}
.select{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:#eaf6ff}
.container{padding:12px 28px}
.grid{display:grid;grid-template-columns:360px 1fr 420px;gap:18px;align-items:start}
@media (max-width:1200px){ .grid{grid-template-columns:1fr} .rightCol{order:3} .middleCol{order:2} .leftCol{order:1} }
.card{background:var(--card);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 40px rgba(2,6,23,0.45)}
.card h3{margin:0 0 8px 0;font-size:15px}
.tasksList{display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;padding-right:6px}
.task3d{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
  box-shadow: 0 8px 24px rgba(2,6,23,0.6), inset 0 -4px 14px rgba(0,0,0,0.25);
  border:1px solid rgba(255,255,255,0.02)}
.taskName{font-weight:800;font-size:13px}
.taskNote{font-size:12px;color:var(--muted)}
.badge{padding:8px 12px;border-radius:999px;font-weight:800;font-size:12px}
.badge.done{background:linear-gradient(90deg,#12b76a,#065f46);color:white;box-shadow:0 8px 20px rgba(18,183,106,0.08)}
.badge.todo{background:linear-gradient(90deg,#f97316,#b91c1c);color:white;box-shadow:0 8px 20px rgba(249,115,22,0.06)}
.charts{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.chartBox{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);min-height:320px;display:flex;flex-direction:column}
.canvasWrap{flex:1;min-height:240px;display:flex;align-items:stretch}
.small{font-size:13px;color:var(--muted)}
.tableWrap{max-height:420px;overflow:auto;margin-top:8px}
table{width:100%;border-collapse:collapse;color:#eaf6ff;font-size:13px}
thead th{position:sticky;top:0;background:rgba(10,14,24,0.18);padding:8px;color:var(--muted);font-weight:700;text-align:left}
td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
.controlsRow{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.footerSmall{font-size:12px;color:var(--muted);margin-top:10px}
.kv{font-weight:800;color:#fff}
</style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <h1>Stock Team VCB</h1>
      <div class="sub" id="metaLine">Live • <span id="liveDate">—</span> • rows: <span id="rowCount">—</span></div>
    </div>

    <div class="controls">
      <select id="scaleMode" class="select" title="Scale mode">
        <option value="scaled">Auto scale</option>
        <option value="raw">Raw</option>
        <option value="log">Log visual</option>
      </select>
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="uploadBtn" class="btn">Upload JSON</button>
      <button id="pasteBtn" class="btn">Paste JSON</button>
      <button id="exportCsv" class="btn">Export CSV</button>
      <button id="exportImgs" class="btn primary">Export PNGs</button>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <!-- LEFT: tasks -->
      <div class="card leftCol">
        <h3>Daily Tasks</h3>
        <div class="tasksList" id="dailyList"></div>

        <h3 style="margin-top:12px">Weekly Tasks</h3>
        <div class="tasksList" id="weeklyList"></div>
      </div>

      <!-- MIDDLE: charts -->
      <div class="card middleCol">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h3>PI Overview</h3><div class="small" id="piSummary">Loading…</div></div>
          <div class="small">Scale: <span id="currentScale" class="kv">auto</span></div>
        </div>

        <div style="height:12px"></div>

        <div class="charts">
          <div class="chartBox">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div style="font-weight:700">Counted vs Remaining (by Area)</div>
              <div class="small">Top areas only (auto)</div>
            </div>
            <div class="canvasWrap"><canvas id="piBar" style="min-height:320px"></canvas></div>
          </div>

          <div class="chartBox">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div style="font-weight:700">Weekly Qty (by Week)</div>
              <div class="small">Aggregated</div>
            </div>
            <div class="canvasWrap"><canvas id="weeklyLine" style="min-height:320px"></canvas></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="chartBox" style="display:flex;gap:12px;align-items:center;min-height:170px">
          <div style="width:220px;height:170px"><canvas id="dailyGauge" style="min-height:170px"></canvas></div>
          <div>
            <div class="small">Daily progress vs daily target</div>
            <div id="dailyGaugeText" style="font-weight:800;font-size:18px;margin-top:8px">—</div>
            <div id="dailyTargetBreakdown" class="small" style="margin-top:6px">Target computed from weekly averages</div>
          </div>
        </div>
      </div>

      <!-- RIGHT: tables -->
      <div class="card rightCol">
        <h3>PI — Daily by Area</h3>
        <div class="tableWrap">
          <table id="piTable">
            <thead><tr><th>Area</th><th style="text-align:right">Total</th><th style="text-align:right">Counted</th><th style="text-align:right">Behind %</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <h3 style="margin-top:12px">Weekly PI details</h3>
        <div class="tableWrap" style="max-height:220px;overflow:auto">
          <table id="weeklyPiTable">
            <thead><tr><th>Week</th><th>Area</th><th style="text-align:right">Daily Qty</th><th style="text-align:right">Weekly Qty</th><th style="text-align:right">Weekly %</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>

    <div style="height:12px"></div>
    <div class="footerSmall">Tip: if charts look odd switch Scale to <strong>Log visual</strong> or <strong>Raw</strong>. Open console for errors.</div>
  </div>

<script>
// ----------------- Utilities -----------------
function safeNum(v){
  if (v === null || v === undefined) return 0;
  if (typeof v === 'number') return isFinite(v)?v:0;
  if (typeof v === 'string') {
    const s = v.replace(/\s/g,'').replace(/,/g,'');
    const n = Number(s); return isFinite(n) ? n : 0;
  }
  return 0;
}
function findKey(obj, names){
  if (!obj) return undefined;
  if (!Array.isArray(names)) names = [names];
  const keys = Object.keys(obj);
  for (const n of names){
    for (const k of keys) if (k.trim().toLowerCase() === n.trim().toLowerCase()) return k;
  }
  for (const n of names){
    for (const k of keys) if (k.trim().toLowerCase().indexOf(n.trim().toLowerCase()) !== -1) return k;
  }
  return undefined;
}
function excelSerialToISO(serial){
  if (serial === null || serial === undefined) return '';
  if (typeof serial === 'string' && serial.indexOf('-') !== -1) return serial;
  const s = Number(serial) || 0;
  const ms = (s - 25569) * 86400 * 1000;
  const d = new Date(ms);
  const dt = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
  return dt.toISOString().slice(0,10);
}
function formatNumber(n){
  n = Number(n) || 0;
  if (!isFinite(n)) return String(n);
  if (Math.abs(n) >= 1e9) return (n/1e9).toFixed(2)+'B';
  if (Math.abs(n) >= 1e6) return (n/1e6).toFixed(2)+'M';
  if (Math.abs(n) >= 1e3) return (n/1e3).toFixed(1)+'K';
  return n.toString();
}
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ----------------- Globals & DOM -----------------
let charts = { piBar:null, weeklyLine:null, dailyGauge:null, tasksDonut:null };
let currentPayload = null;
const refreshBtn = document.getElementById('refreshBtn');
const uploadBtn = document.getElementById('uploadBtn');
const pasteBtn = document.getElementById('pasteBtn');
const scaleModeEl = document.getElementById('scaleMode');
const exportCsvBtn = document.getElementById('exportCsv');
const exportImgsBtn = document.getElementById('exportImgs');

refreshBtn.addEventListener('click', loadData);
uploadBtn.addEventListener('click', onUpload);
pasteBtn.addEventListener('click', onPaste);
scaleModeEl.addEventListener('change', ()=>{ if (currentPayload) render(currentPayload); });
exportCsvBtn.addEventListener('click', exportCsv);
exportImgsBtn.addEventListener('click', exportImages);

// ----------------- Demo fallback payload (uses your JSON sample) -----------------
const demoPayload = {
  piData:[
    {"Date ":46010,"Area ":"MPR","Total locations":14622,"Counted ":3936,"Behind targe":0,"Above target":222.476,"Behind %":0},
    {"Date ":46010,"Area ":"PB1","Total locations":4329,"Counted ":1189,"Behind targe":0,"Above target":89.5714,"Behind %":0},
    {"Date ":46010,"Area ":"MP","Total locations":25612,"Counted ":7409,"Behind targe":0,"Above target":904.365,"Behind %":0},
    {"Date ":46010,"Area ":"Total:","Total locations":137369,"Counted ":37994,"Behind targe":237.714,"Above target":3245.81,"Behind %":0.00173}
  ],
  dailyTask:[{"DATE":46010,"Task ":"SHRINKAGE RECONCILATION DAILY","Status":"Not started","Type":"Daily"},{"DATE":46010,"Task ":"Aged stock report 7AM","Status":"Completed","Type":"Daily"}],
  weeklyTask:[{"Date":46010,"Task":"(Weekly) SLA","Status":"Completed","Type":"Weekly"}],
  weeklyPiData:[{"Date ":46010,"Area ":"MPR","Daily Qty":127,"Week No":32," Weekly Qty":4524," Weekly %":0.7584}],
  meta:{ today: new Date().toLocaleDateString(), rows: 42 }
};

// ----------------- Load / Input -----------------
function loadData(){
  // pasted JSON priority
  const pasted = (document.getElementById('jsonPaste') && document.getElementById('jsonPaste').value) ? null : null;
  // attempt fetch
  refreshBtn.disabled = true; refreshBtn.innerText = 'Refreshing…';
  fetch('./data/dashboard.json?_=' + Date.now())
    .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
    .then(json => { currentPayload = json; initRender(); })
    .catch(err => {
      console.warn('fetch failed', err);
      currentPayload = demoPayload;
      initRender(true);
    })
    .finally(()=>{ refreshBtn.disabled = false; refreshBtn.innerText = 'Refresh'; });
}

function onUpload(){
  const input = document.createElement('input'); input.type = 'file'; input.accept = '.json,application/json';
  input.onchange = e => {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        const json = JSON.parse(ev.target.result);
        currentPayload = json; initRender();
        // show JSON in metaLine small
        document.getElementById('metaLine').innerText = 'Loaded: uploaded JSON';
      } catch(e){ alert('Invalid JSON file'); console.error(e); }
    }; r.readAsText(f);
  }; input.click();
}
function onPaste(){
  const txt = prompt('Paste dashboard JSON here (entire JSON object).'); 
  if (!txt) return;
  try { const json = JSON.parse(txt); currentPayload = json; initRender(); document.getElementById('metaLine').innerText = 'Loaded: pasted JSON'; }
  catch(e){ alert('Invalid JSON pasted'); console.error(e); }
}

// ----------------- Render pipeline -----------------
function initRender(fallback=false){
  if (!currentPayload) currentPayload = demoPayload;
  document.getElementById('liveDate').innerText = (currentPayload.meta && currentPayload.meta.today) ? currentPayload.meta.today : new Date().toLocaleDateString();
  document.getElementById('rowCount').innerText = (currentPayload.meta && currentPayload.meta.rows) ? currentPayload.meta.rows : (Array.isArray(currentPayload.piData) ? currentPayload.piData.length : '—');

  renderTasks(currentPayload.dailyTask || [], 'dailyList');
  renderTasks(currentPayload.weeklyTask || [], 'weeklyList');
  renderPI(currentPayload.piData || []);
  renderWeeklyPI(currentPayload.weeklyPiData || []);
  computeDailyTargetAndGauge(currentPayload);
}

function renderTasks(list, elementId){
  const el = document.getElementById(elementId); el.innerHTML = '';
  if (!Array.isArray(list) || list.length === 0){ el.innerHTML = '<div class="small">No tasks</div>'; return; }
  // sort incomplete first
  list.sort((a,b)=>{
    const sa = String(a.Status || a['Status '] || '').toLowerCase();
    const sb = String(b.Status || b['Status '] || '').toLowerCase();
    const da = sa.includes('complete') || sa.includes('done');
    const db = sb.includes('complete') || sb.includes('done');
    if (da && !db) return 1; if (db && !da) return -1; return 0;
  });
  list.forEach(item => {
    const key = findKey(item, ['Task ','Task','task']);
    const name = key ? item[key] : JSON.stringify(item).slice(0,60);
    const status = item.Status || item['Status '] || item.status || '';
    const done = String(status).toLowerCase().includes('complete') || String(status).toLowerCase().includes('done');
    const div = document.createElement('div'); div.className = 'task3d';
    div.innerHTML = `<div style="max-width:72%"><div class="taskName">${escapeHtml(name)}</div><div class="taskNote">${escapeHtml(status)}</div></div>
      <div><div class="badge ${done ? 'done':'todo'}">${done ? 'Completed':'Not started'}</div></div>`;
    el.appendChild(div);
  });
}

// ----------------- PI Table & charts -----------------
function renderPI(piList){
  const rows = Array.isArray(piList) ? piList.slice() : [];
  const tbody = document.querySelector('#piTable tbody'); tbody.innerHTML = '';
  if (!rows.length){ tbody.innerHTML = '<tr><td colspan="4" class="small">No PI data</td></tr>'; if (charts.piBar){ charts.piBar.destroy(); charts.piBar=null; } return; }

  // pick sample (skip any header-like row)
  const sample = rows.find(r => {
    return !Object.values(r).some(v => (typeof v === 'string' && (/area|total locations|counted/i).test(v)));
  }) || rows[0];

  const areaKey = findKey(sample, ['Area','Area ']);
  const totalKey = findKey(sample, ['Total locations','Total locations ','Total']);
  const countedKey = findKey(sample, ['Counted','Counted ']);
  const behindKey = findKey(sample, ['Behind %','Behind % ','Behind targe','Behind target']);

  const data = [];
  for (const r of rows){
    // skip header-like rows
    if (Object.values(r).some(v => typeof v === 'string' && (/total locations|area|counted/i).test(String(v)))) continue;
    const area = String(r[areaKey] || r['Area'] || r['Area '] || '').trim();
    if (!area) continue;
    if (area.toLowerCase().includes('total')) continue; // omit total for chart, keep summary later
    const total = safeNum(r[totalKey] || r['Total locations'] || r['Total locations '] || 0);
    const counted = Math.min(safeNum(r[countedKey] || r['Counted '] || 0), total);
    let behindRaw = safeNum(r[behindKey] || r['Behind %'] || r['Behind % '] || r['Behind targe'] || r['Behind target'] || 0);
    let behindPct = behindRaw;
    if (behindRaw > 0 && behindRaw <= 1) behindPct = behindRaw * 100;
    data.push({ area, total, counted, behindRaw, behindPct });
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${escapeHtml(area)}</td>
      <td style="text-align:right">${formatNumber(total)}</td>
      <td style="text-align:right">${formatNumber(counted)}</td>
      <td style="text-align:right">${Number(behindPct||0).toFixed(2)}%</td>
    </tr>`);
  }

  const totalSum = data.reduce((s,d)=>s+d.total,0);
  const countedSum = data.reduce((s,d)=>s+d.counted,0);
  document.getElementById('piSummary').innerText = `Locations: ${totalSum.toLocaleString()} • Counted: ${countedSum.toLocaleString()} • Coverage: ${((countedSum/Math.max(1,totalSum))*100).toFixed(2)}%`;

  // prepare chart arrays
  let labels = data.map(d=>d.area);
  let countedDs = data.map(d=>d.counted);
  let totalDs = data.map(d=>d.total);
  if (labels.length === 0){ labels = ['No data']; countedDs=[1]; totalDs=[1]; }

  // scale mode
  const mode = scaleModeEl.value || 'scaled';
  document.getElementById('currentScale').innerText = mode;

  let cForChart = countedDs.slice();
  let tForChart = totalDs.slice();

  if (mode === 'log'){
    cForChart = cForChart.map(v => Math.log10(Math.max(1,v)));
    tForChart = tForChart.map(v => Math.log10(Math.max(1,v)));
  } else if (mode === 'scaled'){
    const maxVal = Math.max(...tForChart,1);
    let factor = 1;
    if (maxVal > 100000) factor = 0.001;
    else if (maxVal > 20000) factor = 0.01;
    else if (maxVal > 5000) factor = 0.1;
    cForChart = cForChart.map(v => Number((v*factor).toFixed(3)));
    tForChart = tForChart.map(v => Number((v*factor).toFixed(3)));
  }

  // limit max labels
  const MAX = 40;
  if (labels.length > MAX){
    const idx = tForChart.map((v,i)=>({v,i})).sort((a,b)=>b.v-a.v).slice(0,MAX).map(x=>x.i).sort((a,b)=>a-b);
    labels = idx.map(i=>labels[i]);
    cForChart = idx.map(i=>cForChart[i]);
    tForChart = idx.map(i=>tForChart[i]);
  }

  // destroy existing
  try { if (charts.piBar) charts.piBar.destroy(); } catch(e){ console.warn(e); charts.piBar=null; }

  // register bar3D plugin (if not registered)
  if (!Chart.registry.getPlugin('bar3D')) {
    const bar3D = {
      id: 'bar3D',
      afterDatasetsDraw(chart){
        const ctx = chart.ctx;
        const meta = chart.getDatasetMeta(0);
        if (!meta || !meta.data) return;
        // draw depth layers by painting darker rects behind each bar with small offset
        ctx.save();
        for (let i=0;i<meta.data.length;i++){
          const el = meta.data[i];
          const r = el.getBoundingClientRect ? el.getBoundingClientRect() : null;
          // Chart elements provide getProps - but safest: use element properties
          const model = el;
          const x = el.x || (el.x || 0);
          const y = el.y || (el.y || 0);
          // We cannot rely on internal API; instead draw a subtle shadow below bar by using globalCompositeOperation
        }
        // We will rely on built-in shadow for container to provide depth-like look (CSS)
        ctx.restore();
      }
    };
    Chart.register(bar3D);
  }

  // create stacked bar
  const ctx = document.getElementById('piBar').getContext('2d');
  charts.piBar = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Counted', data: cForChart, backgroundColor: createGradient(ctx,'top','rgba(125,211,252,0.98)','rgba(48,113,146,0.18)') },
        { label: 'Remaining', data: tForChart.map((t,i)=>Math.max(0,t - (cForChart[i]||0))), backgroundColor: createGradient(ctx,'top','rgba(139,92,246,0.95)','rgba(90,55,115,0.12)') }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{position:'top'}, tooltip:{mode:'index', intersect:false}},
      scales:{
        x:{ticks:{color:'#cfeeff'}, grid:{display:false}},
        y:{beginAtZero:true, ticks:{color:'#cfeeff', callback: v => formatNumber(v)}}
      },
      interaction:{mode:'index', intersect:false},
      onResize: ()=>{ /* nothing */ }
    }
  });
}

function createGradient(ctx, dir, c1, c2){
  const g = ctx.createLinearGradient(0,0,0,ctx.canvas.height);
  g.addColorStop(0,c1);
  g.addColorStop(1,c2);
  return g;
}

// ----------------- Weekly PI -----------------
function renderWeeklyPI(list){
  const arr = Array.isArray(list) ? list.slice() : [];
  const tbody = document.querySelector('#weeklyPiTable tbody'); tbody.innerHTML = '';
  if (!arr.length){ tbody.innerHTML = '<tr><td colspan="5" class="small">No weekly PI data</td></tr>'; if (charts.weeklyLine){ charts.weeklyLine.destroy(); charts.weeklyLine=null; } return; }
  const areaKey = findKey(arr[0], ['Area','Area ']);
  const weekKey = findKey(arr[0], ['Week No','WeekNo','Week']);
  const dailyKey = findKey(arr[0], ['Daily Qty','DailyQty','Daily']);
  const weeklyQtyKey = findKey(arr[0], [' Weekly Qty','Weekly Qty','WeeklyQty',' Weekly Qty']);

  const agg = {};
  arr.forEach(r=>{
    const area = r[areaKey] || r['Area'] || '';
    const week = r[weekKey] || r['Week No'] || r['Week'] || '';
    const dailyQty = safeNum(r[dailyKey] || 0);
    const weeklyQty = safeNum(r[weeklyQtyKey] || 0);
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${escapeHtml(week)}</td><td>${escapeHtml(area)}</td><td style="text-align:right">${formatNumber(dailyQty)}</td><td style="text-align:right">${formatNumber(weeklyQty)}</td><td style="text-align:right">${(safeNum(r[' Weekly %']||r['Weekly %']||0)*100).toFixed(3)}%</td>
    </tr>`);
    const wk = String(week);
    agg[wk] = (agg[wk] || 0) + weeklyQty;
  });

  const numericWeeks = Object.keys(agg).map(k=>Number(k)).filter(n=>!isNaN(n)).sort((a,b)=>a-b);
  const labels = numericWeeks.length ? numericWeeks.map(String) : Object.keys(agg);
  const values = labels.map(l => agg[l] || 0);

  document.getElementById('pointCount').innerText = labels.length || 0;

  // scale mode transform
  const mode = scaleModeEl.value || 'scaled';
  let vals = values.slice();
  if (mode === 'log') vals = vals.map(v => Math.log10(Math.max(1,v)));
  else if (mode === 'scaled'){
    const maxVal = Math.max(...vals,1);
    if (maxVal > 100000) vals = vals.map(v => v * 0.001);
    else if (maxVal > 20000) vals = vals.map(v => v * 0.01);
  }

  try{ if (charts.weeklyLine) charts.weeklyLine.destroy(); } catch(e){ charts.weeklyLine=null; }
  const ctx = document.getElementById('weeklyLine').getContext('2d');
  charts.weeklyLine = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{ label:'Weekly Qty', data: vals, borderColor:'rgba(125,211,252,0.95)', backgroundColor:'rgba(125,211,252,0.08)', fill:true, tension:0.28, pointRadius:3 }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ x:{ticks:{color:'#cfeeff'}}, y:{ticks:{color:'#cfeeff', callback: v => formatNumber(v)}} }
  });
}

// ----------------- Daily target gauge -----------------
function computeDailyTargetAndGauge(payload){
  const weeklyData = (payload && payload.weeklyPiData) ? payload.weeklyPiData : [];
  const piData = (payload && payload.piData) ? payload.piData : [];
  // compute daily target as sum of weeklyQty/7 across weeklyData
  let dailyTargetSum = 0;
  if (Array.isArray(weeklyData) && weeklyData.length){
    weeklyData.forEach(w => {
      const weeklyQty = safeNum(w[' Weekly Qty'] || w['Weekly Qty'] || w[' Weekly Qty']);
      dailyTargetSum += weeklyQty/7;
    });
  } else {
    // fallback: 10% of total locations
    const sample = Array.isArray(piData) ? piData.slice() : [];
    const totalSum = sample.reduce((s,r)=>{
      const tk = findKey(r, ['Total locations','Total locations ','Total']);
      return s + safeNum(r[tk] || r['Total locations'] || 0);
    },0);
    dailyTargetSum = totalSum * 0.10;
  }

  const countedSum = (Array.isArray(piData) ? piData : []).reduce((s,r)=>{
    const ck = findKey(r, ['Counted','Counted ']);
    return s + safeNum(r[ck] || r['Counted '] || 0);
  },0);

  const progress = dailyTargetSum ? Math.min(1, countedSum / dailyTargetSum) : 0;
  renderDailyGauge(progress, countedSum, dailyTargetSum);
}

function renderDailyGauge(pct, countedSum, targetSum){
  const percent = Math.max(0, Math.min(1, pct || 0));
  document.getElementById('dailyGaugeText').innerText = `${(percent*100).toFixed(2)}% • ${countedSum.toLocaleString()} / ${Math.round(targetSum).toLocaleString()}`;

  try{ if (charts.dailyGauge) charts.dailyGauge.destroy(); } catch(e){ charts.dailyGauge=null; }

  // register donut3D plugin if needed
  if (!Chart.registry.getPlugin('donut3D')) {
    const donut3D = {
      id: 'donut3D',
      beforeDraw(chart, args, options){
        if (!options || !options.depth) return;
        const ctx = chart.ctx;
        const meta = chart.getDatasetMeta(0);
        if (!meta) return;
        const first = meta.data[0];
        const centerX = (chart.chartArea.left + chart.chartArea.right)/2;
        const centerY = (chart.chartArea.top + chart.chartArea.bottom)/2;
        const outerRadius = first && first.outerRadius ? first.outerRadius : (Math.min(chart.width, chart.height)/2 * 0.9);
        const innerRadius = first && first.innerRadius ? first.innerRadius : (outerRadius * 0.6);
        const depth = options.depth;
        const slices = chart.data.datasets[0].data;
        const colors = chart.data.datasets[0].backgroundColor;
        let startAngle = (chart.options.rotation || 0) - Math.PI/2;
        const total = slices.reduce((s,v)=>s + (typeof v === 'number' ? v : 0),0) || 1;
        const angles = [];
        for (let si=0; si<slices.length; si++){
          const a = (slices[si]/total) * (chart.options.circumference || (Math.PI*2));
          angles.push({ start: startAngle, end: startAngle + a });
          startAngle += a;
        }
        const step = Math.max(2, Math.round(depth/6));
        for (let layer = depth; layer > 0; layer -= step){
          const yOffset = layer * 0.6;
          for (let i=0;i<angles.length;i++){
            const ainfo = angles[i];
            ctx.beginPath();
            ctx.fillStyle = shadeColor(colors[i] || 'rgba(255,255,255,0.08)', -0.18 - (layer/depth)*0.12);
            ctx.moveTo(centerX, centerY + yOffset);
            ctx.arc(centerX, centerY + yOffset, outerRadius, ainfo.start, ainfo.end);
            ctx.arc(centerX, centerY + yOffset, innerRadius, ainfo.end, ainfo.start, true);
            ctx.closePath();
            ctx.fill();
          }
        }
      }
    };
    Chart.register(donut3D);
  }

  const ctx = document.getElementById('dailyGauge').getContext('2d');
  charts.dailyGauge = new Chart(ctx, {
    type:'doughnut',
    data:{ labels:['progress','rest'], datasets:[{ data:[percent, Math.max(0,1-percent)], backgroundColor:['rgba(125,211,252,0.98)','rgba(255,255,255,0.06)'] }]},
    options:{ responsive:true, maintainAspectRatio:false, cutout:'78%', rotation:-90*Math.PI/180, circumference:180*Math.PI/180, plugins:{legend:{display:false}, donut3D:{depth:16}} },
  });

  // center text plugin (one-time register)
  if (!Chart.registry.getPlugin('centerText')) {
    const centerText = {
      id: 'centerText',
      afterDraw(chart){
        const cfg = chart.config.options.plugins.centerText;
        if (!cfg) return;
        const ctx = chart.ctx; ctx.save();
        const x = (chart.chartArea.left + chart.chartArea.right)/2;
        const y = (chart.chartArea.top + chart.chartArea.bottom)/2;
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillStyle = cfg.color || '#fff'; ctx.font = cfg.font || '700 16px Poppins';
        ctx.fillText(cfg.text || '', x, y-8);
        if (cfg.subtext){ ctx.font = cfg.subFont || '400 12px Poppins'; ctx.fillStyle = cfg.subColor || '#cbd6e6'; ctx.fillText(cfg.subtext, x, y+12); }
        ctx.restore();
      }
    };
    Chart.register(centerText);
  }
  // attach center text to chart
  charts.dailyGauge.config.options.plugins.centerText = { text: (percent*100).toFixed(2) + '%', subtext: `raw: ${countedSum}/${Math.round(targetSum)}`, color:'#fff' };
  charts.dailyGauge.update();
}

// ----------------- Export functions -----------------
function exportCsv(){
  const rows = [['Area','Total','Counted','Behind %']];
  document.querySelectorAll('#piTable tbody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    if (!tds.length) return;
    rows.push([tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText]);
  });
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'pi_by_area.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function exportImages(){
  const ids = ['piBar','weeklyLine','dailyGauge'];
  ids.forEach(id=>{
    const canvas = document.getElementById(id);
    if (!canvas) return;
    try { const url = canvas.toDataURL('image/png'); const a = document.createElement('a'); a.href = url; a.download = id + '.png'; document.body.appendChild(a); a.click(); a.remove(); } catch(e){ console.warn(e); }
  });
}

// ----------------- Helpers -----------------
function shadeColor(css, percent){
  try {
    if (css.indexOf('rgba')===0 || css.indexOf('rgb')===0){
      const nums = css.replace(/rgba?\(|\)|\s/g,'').split(',').map(n=>Number(n));
      const r = Math.round(nums[0]*(1+percent)), g = Math.round(nums[1]*(1+percent)), b = Math.round(nums[2]*(1+percent));
      const a = nums.length>3?nums[3]:1; return 'rgba('+clamp(r,0,255)+','+clamp(g,0,255)+','+clamp(b,0,255)+','+a+')';
    }
    if (css[0]==='#'){ let c = css.substring(1); if (c.length===3){ let tmp=''; for (let i=0;i<c.length;i++) tmp+=c[i]+c[i]; c=tmp; } const num = parseInt(c,16); const rr = (num>>16) + Math.round(255*percent); const gg = ((num>>8)&0x00FF) + Math.round(255*percent); const bb = (num&0x0000FF) + Math.round(255*percent); return 'rgba('+clamp(rr,0,255)+','+clamp(gg,0,255)+','+clamp(bb,0,255)+',1)'; }
  } catch(e){}
  return css;
}
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

// ----------------- Init (load) -----------------
(function init(){
  // try load immediately
  loadData();
})();

</script>
</body>
</html>
