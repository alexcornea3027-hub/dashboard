<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Team VCB</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {font-family: Arial,sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:20px;}
h1,h2 {margin:0 0 10px 0;}
.grid {display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;}
.card {background:#111827;padding:15px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.5);}
.task3d {display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:12px;background:linear-gradient(180deg,#1e293b,#111827);margin-bottom:8px;box-shadow:0 4px 10px rgba(0,0,0,.5);}
.badge {padding:5px 10px;border-radius:999px;font-weight:700;font-size:12px;color:#fff;}
.done {background:linear-gradient(90deg,#22c55e,#15803d);}
.todo {background:linear-gradient(90deg,#f87171,#b91c1c);}
canvas {background:#0f172a;border-radius:12px;}
.tableWrap{max-height:300px;overflow:auto;}
table{width:100%;border-collapse:collapse;color:#e5e7eb;}
th,td{padding:8px;border-bottom:1px solid #1f2933;text-align:left;}
th{color:#93c5fd;}
</style>
</head>
<body>

<h1>Stock Team VCB</h1>

<h2>Daily Tasks</h2>
<div id="daily" class="card"></div>

<h2>Weekly Tasks</h2>
<div id="weekly" class="card"></div>

<h2>PI by Area</h2>
<div class="card">
  <canvas id="piChart" height="300"></canvas>
  <div class="tableWrap">
    <table id="piTable">
      <thead>
        <tr><th>Area</th><th>Total</th><th>Counted</th><th>Behind %</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<h2>Weekly Quantity</h2>
<div class="card">
  <canvas id="weeklyChart" height="250"></canvas>
</div>

<h2>Daily Progress</h2>
<div class="card">
  <canvas id="dailyGauge" height="250"></canvas>
  <div id="dailyText"></div>
</div>

<script>
async function loadData() {
  let data;
  try {
    const res = await fetch('./data/dashboard.json?_=' + Date.now());
    data = await res.json();
  } catch(e) {
    alert("Could not load dashboard.json, using fallback data.");
    data = {
      dailyTask:[{"Task ":"Check stock","Status":"Completed"},{"Task ":"Reconciliation","Status":"Not started"}],
      weeklyTask:[{"Task":"Weekly SLA","Status":"Completed"}],
      piData:[{"Area ":"MPR","Total locations":100,"Counted ":60,"Behind %":0.4},{"Area ":"PB1","Total locations":50,"Counted ":25,"Behind %":0.5}],
      weeklyPiData:[{"Week":1,"Qty":100},{"Week":2,"Qty":120}]
    };
  }
  renderDashboard(data);
}

function renderTasks(list,id){
  const container=document.getElementById(id);
  container.innerHTML="";
  if(!list.length){container.innerHTML="<i>No tasks</i>";return;}
  list.forEach(t=>{
    const done = String(t.Status || '').toLowerCase().includes('complete');
    const div=document.createElement('div');
    div.className='task3d';
    div.innerHTML=`<div>${t.Task}</div><div class="badge ${done?'done':'todo'}">${done?'Completed':'Not started'}</div>`;
    container.appendChild(div);
  });
}

function renderPI(piData){
  const tableBody=document.querySelector('#piTable tbody');
  tableBody.innerHTML="";
  const areas=[],counted=[],remaining=[];
  piData.forEach(r=>{
    const area=r['Area ']||r['Area']||'';
    const total=Number(r['Total locations']||0);
    const c=Number(r['Counted ']||0);
    const behindPct=Number(r['Behind %']||0)*100;
    areas.push(area); counted.push(c); remaining.push(total-c);
    const row=document.createElement('tr');
    row.innerHTML=`<td>${area}</td><td>${total}</td><td>${c}</td><td>${behindPct.toFixed(2)}%</td>`;
    tableBody.appendChild(row);
  });
  const ctx=document.getElementById('piChart').getContext('2d');
  new Chart(ctx,{type:'bar',data:{labels:areas,datasets:[{label:'Counted',data:counted,backgroundColor:'#22c55e'},{label:'Remaining',data:remaining,backgroundColor:'#f87171'}]},options:{responsive:true,plugins:{legend:{position:'top'}}}});
}

function renderWeekly(weeklyData){
  const ctx=document.getElementById('weeklyChart').getContext('2d');
  const weeks=[],qtys=[];
  weeklyData.forEach(r=>{
    weeks.push(r.Week||r['Week']);
    qtys.push(Number(r.Qty||0));
  });
  new Chart(ctx,{type:'line',data:{labels:weeks,datasets:[{label:'Weekly Qty',data:qtys,borderColor:'#22c55e',backgroundColor:'rgba(34,197,94,0.2)',fill:true,tension:0.3}]}});
}

function renderDailyGauge(piData){
  const totalCounted = piData.reduce((a,r)=>a+Number(r['Counted ']||0),0);
  const totalTarget = piData.reduce((a,r)=>a+Number(r['Total locations']||0),0);
  const pct=Math.min(1,totalCounted/totalTarget);
  const ctx=document.getElementById('dailyGauge').getContext('2d');
  new Chart(ctx,{type:'doughnut',data:{labels:['Done','Remaining'],datasets:[{data:[pct,1-pct],backgroundColor:['#22c55e','#f87171']}]},options:{cutout:'70%',plugins:{legend:{display:false}}}});
  document.getElementById('dailyText').innerText=`${(pct*100).toFixed(1)}% â€¢ ${totalCounted}/${totalTarget}`;
}

function renderDashboard(data){
  renderTasks(data.dailyTask||[],'daily');
  renderTasks(data.weeklyTask||[],'weekly');
  renderPI(data.piData||[]);
  renderWeekly(data.weeklyPiData||[]);
  renderDailyGauge(data.piData||[]);
}

loadData();
</script>
</body>
</html>
