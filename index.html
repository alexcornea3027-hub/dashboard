/*
VCB StockTeam Dashboard — single-file React component (default export)
Reads data from: /data/dashboard.json (place your JSON file in the repo at that path or serve it from your server)

How to use:
1) Put data/dashboard.json in your repository/public so it is served at /data/dashboard.json.
2) Install deps: npm install recharts framer-motion lucide-react
3) Ensure Tailwind is configured in your project for the styling to match. If you don't use Tailwind, the layout will still work but look will be basic.
4) Put this file into src/components/VCB_StockTeam_Dashboard.jsx and import it in your app (or replace App.jsx).

Notes:
- Warm professional palette used.
- Responsive Recharts charts: Pie charts for Daily & Weekly task statuses, Bar chart for weekly volumes, Table for area KPIs.
- Uses fetch to read /data/dashboard.json; shows a loading and error state.
*/

import React, { useEffect, useMemo, useState } from 'react';
import {
  PieChart,
  Pie,
  Cell,
  Tooltip,
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Legend,
  CartesianGrid,
} from 'recharts';
import { motion } from 'framer-motion';
import { Search, RefreshCw } from 'lucide-react';

const WARM_PALETTE = [
  '#D97706', // amber-600
  '#FB923C', // orange-400
  '#F97316', // orange-500
  '#F59E0B', // amber-500
  '#C2410C', // deep orange
  '#7C2D12',
];

function humanNumber(n) {
  if (n == null) return '-';
  if (Math.abs(n) >= 1e9) return (n / 1e9).toFixed(1) + 'B';
  if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(1) + 'k';
  return String(n);
}

export default function VCBStockTeamDashboard() {
  const [data, setData] = useState(null);
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(true);
  const [taskSearch, setTaskSearch] = useState('');

  useEffect(() => {
    let mounted = true;
    setLoading(true);
    fetch('/data/dashboard.json')
      .then((r) => {
        if (!r.ok) throw new Error('Failed to load /data/dashboard.json');
        return r.json();
      })
      .then((json) => {
        if (!mounted) return;
        setData(json);
        setLoading(false);
      })
      .catch((err) => {
        if (!mounted) return;
        setError(err.message);
        setLoading(false);
      });
    return () => (mounted = false);
  }, []);

  const overview = useMemo(() => {
    if (!data) return null;
    const totalLocations = data.piData.reduce((s, r) => s + (r['Total locations'] || 0), 0);
    const counted = data.piData.reduce((s, r) => s + (r.Counted || 0), 0);
    const aboveTarget = data.piData.reduce((s, r) => s + (r['Above target'] || 0), 0);
    const behindTarget = data.piData.reduce((s, r) => s + (r['Behind targe'] || 0), 0);
    return { totalLocations, counted, aboveTarget, behindTarget };
  }, [data]);

  const dailyTaskStatus = useMemo(() => {
    if (!data) return [];
    const counts = {};
    data.dailyTask.forEach((t) => {
      const s = t.Status || 'Unknown';
      counts[s] = (counts[s] || 0) + 1;
    });
    return Object.keys(counts).map((k, i) => ({ name: k, value: counts[k], color: WARM_PALETTE[i % WARM_PALETTE.length] }));
  }, [data]);

  const weeklyTaskStatus = useMemo(() => {
    if (!data) return [];
    const counts = {};
    data.weeklyTask.forEach((t) => {
      const s = t.Status || 'Unknown';
      counts[s] = (counts[s] || 0) + 1;
    });
    return Object.keys(counts).map((k, i) => ({ name: k, value: counts[k], color: WARM_PALETTE[(i + 2) % WARM_PALETTE.length] }));
  }, [data]);

  const weeklyVolumes = useMemo(() => {
    if (!data) return [];
    // weeklyPiData: map Week No -> Weekly Qty
    return data.weeklyPiData
      .map((r) => ({ week: r['Week No'] || r['Week No'] === 0 ? r['Week No'] : String(r['Week No']), qty: r['Weekly Qty'] || 0 }))
      .sort((a, b) => (a.week > b.week ? 1 : -1));
  }, [data]);

  const filteredDailyTasks = useMemo(() => {
    if (!data) return [];
    const q = taskSearch.trim().toLowerCase();
    return data.dailyTask.filter((t) => {
      if (!q) return true;
      return (t.Task || '').toLowerCase().includes(q) || (t.Status || '').toLowerCase().includes(q);
    });
  }, [data, taskSearch]);

  if (loading) return (
    <div className="min-h-screen flex items-center justify-center p-6">
      <div className="text-center">
        <div className="animate-spin mb-4" style={{ borderTop: '4px solid rgba(0,0,0,0.1)', borderRight: '4px solid rgba(0,0,0,0.1)', borderBottom: '4px solid rgba(0,0,0,0.1)', borderLeft: '4px solid #D97706', borderRadius: '50%', width: 48, height: 48 }} />
        <div className="text-muted">Loading dashboard data from <code>/data/dashboard.json</code> ...</div>
      </div>
    </div>
  );

  if (error) return (
    <div className="min-h-screen flex items-center justify-center p-6">
      <div className="bg-white p-6 rounded-lg shadow-md max-w-xl">
        <h3 className="text-lg font-semibold mb-2">Failed to load dashboard data</h3>
        <p className="mb-4">{error}</p>
        <button className="inline-flex items-center gap-2 px-4 py-2 rounded-md border" onClick={() => window.location.reload()}>
          <RefreshCw size={16} /> Reload
        </button>
      </div>
    </div>
  );

  return (
    <div className="p-6 font-sans bg-gray-50 min-h-screen">
      <header className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-2xl font-semibold text-amber-800">VCB StockTeam Dashboard</h1>
          <p className="text-sm text-gray-600">Snapshot date: <strong>{data.piData[0]?.Date || '-'}</strong></p>
        </div>
        <div className="flex items-center gap-3">
          <div className="flex items-center border rounded-md px-3 py-1 bg-white">
            <Search size={16} />
            <input placeholder="Search tasks..." value={taskSearch} onChange={(e) => setTaskSearch(e.target.value)} className="ml-2 outline-none" />
          </div>
          <motion.button whileTap={{ scale: 0.95 }} onClick={() => window.location.reload()} className="px-3 py-2 rounded-md bg-amber-500 text-white">Refresh</motion.button>
        </div>
      </header>

      {/* Overview */}
      <section className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <Card title="Total locations" value={humanNumber(overview.totalLocations)} sub={`Counted: ${humanNumber(overview.counted)}`} />
        <Card title="Counted" value={humanNumber(overview.counted)} sub={`Above target: ${humanNumber(Math.round(overview.aboveTarget))}`} />
        <Card title="Above target (sum)" value={humanNumber(Math.round(overview.aboveTarget))} sub={`Behind target: ${humanNumber(Math.round(overview.behindTarget))}`} />
        <Card title="Completion %" value={`${((overview.counted / Math.max(overview.totalLocations,1)) * 100).toFixed(1)}%`} sub={`Based on total locations`} />
      </section>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Left: Area Table */}
        <div className="col-span-1 lg:col-span-2 bg-white rounded-2xl shadow p-4">
          <h2 className="text-lg font-medium mb-3">Area KPIs</h2>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left text-gray-500 border-b">
                  <th className="py-2">Area</th>
                  <th>Total locations</th>
                  <th>Counted</th>
                  <th>Above target</th>
                  <th>Behind target</th>
                  <th>Behind %</th>
                </tr>
              </thead>
              <tbody>
                {data.piData.map((r, i) => (
                  <tr key={r.Area} className={`${i % 2 ? 'bg-gray-50' : ''}`}>
                    <td className="py-2 font-medium">{r.Area}</td>
                    <td>{humanNumber(r['Total locations'])}</td>
                    <td>{humanNumber(r.Counted)}</td>
                    <td>{r['Above target'] ? r['Above target'].toFixed(2) : 0}</td>
                    <td>{r['Behind targe'] ? r['Behind targe'].toFixed(2) : 0}</td>
                    <td>{r['Behind %'] ? (r['Behind %'] * 100).toFixed(2) + '%' : '0%'}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        {/* Right: Charts */}
        <aside className="space-y-6">
          <div className="bg-white rounded-2xl shadow p-4 h-64">
            <h3 className="text-sm font-medium mb-2">Daily Tasks — status</h3>
            <ResponsiveContainer width="100%" height={160}>
              <PieChart>
                <Pie data={dailyTaskStatus} dataKey="value" nameKey="name" outerRadius={60} innerRadius={28} label>
                  {dailyTaskStatus.map((entry, idx) => (
                    <Cell key={`d-${idx}`} fill={entry.color} />
                  ))}
                </Pie>
                <Tooltip />
              </PieChart>
            </ResponsiveContainer>
          </div>

          <div className="bg-white rounded-2xl shadow p-4 h-64">
            <h3 className="text-sm font-medium mb-2">Weekly Tasks — status</h3>
            <ResponsiveContainer width="100%" height={160}>
              <PieChart>
                <Pie data={weeklyTaskStatus} dataKey="value" nameKey="name" outerRadius={60} innerRadius={28} label>
                  {weeklyTaskStatus.map((entry, idx) => (
                    <Cell key={`w-${idx}`} fill={entry.color} />
                  ))}
                </Pie>
                <Tooltip />
              </PieChart>
            </ResponsiveContainer>
          </div>
        </aside>
      </div>

      {/* Weekly volumes chart */}
      <section className="bg-white rounded-2xl shadow p-4 mt-6">
        <h3 className="text-lg font-medium mb-3">Weekly Volumes</h3>
        <div style={{ width: '100%', height: 260 }}>
          <ResponsiveContainer>
            <BarChart data={weeklyVolumes} margin={{ top: 10, right: 20, left: 0, bottom: 5 }}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="week" label={{ value: 'Week No', position: 'insideBottom', offset: -5 }} />
              <YAxis />
              <Tooltip />
              <Legend />
              <Bar dataKey="qty" name="Weekly Qty">
                {weeklyVolumes.map((entry, idx) => (
                  <Cell key={`bar-${idx}`} fill={WARM_PALETTE[idx % WARM_PALETTE.length]} />
                ))}
              </Bar>
            </BarChart>
          </ResponsiveContainer>
        </div>
      </section>

      {/* Tasks list */}
      <section className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <div className="bg-white rounded-2xl shadow p-4">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-lg font-medium">Daily Tasks ({data.dailyTask.length})</h3>
            <div className="text-sm text-gray-500">Showing {filteredDailyTasks.length}</div>
          </div>

          <div className="space-y-2 max-h-80 overflow-auto pr-2">
            {filteredDailyTasks.map((t, i) => (
              <div key={i} className="flex items-center justify-between p-3 rounded-md border">
                <div>
                  <div className="font-medium">{t.Task}</div>
                  <div className="text-xs text-gray-500">{t.DATE}</div>
                </div>
                <StatusBadge status={t.Status} />
              </div>
            ))}
          </div>
        </div>

        <div className="bg-white rounded-2xl shadow p-4">
          <h3 className="text-lg font-medium mb-3">Weekly Tasks</h3>
          <div className="space-y-2">
            {data.weeklyTask.map((t, i) => (
              <div key={i} className="flex items-center justify-between p-3 rounded-md border">
                <div>
                  <div className="font-medium">{t.Task}</div>
                  <div className="text-xs text-gray-500">{t.Date}</div>
                </div>
                <StatusBadge status={t.Status} />
              </div>
            ))}
          </div>
        </div>
      </section>

      <footer className="mt-8 text-center text-xs text-gray-500">Generated by VCB StockTeam Dashboard — data source: /data/dashboard.json</footer>
    </div>
  );
}

function Card({ title, value, sub }) {
  return (
    <div className="bg-white rounded-2xl shadow p-4 flex flex-col justify-between">
      <div>
        <div className="text-sm text-gray-500">{title}</div>
        <div className="text-2xl font-semibold text-amber-800">{value}</div>
      </div>
      {sub && <div className="text-xs text-gray-500 mt-2">{sub}</div>}
    </div>
  );
}

function StatusBadge({ status }) {
  const base = {
    'Completed': { bg: '#DCFCE7', color: '#065F46' },
    'Not started': { bg: '#FFF7ED', color: '#92400E' },
    'In progress': { bg: '#EFF6FF', color: '#1E3A8A' },
    Unknown: { bg: '#F3F4F6', color: '#374151' },
  };
  const s = base[status] || base.Unknown;
  return (
    <div style={{ background: s.bg, color: s.color }} className="px-3 py-1 rounded-full text-xs font-medium">
      {status}
    </div>
  );
}
