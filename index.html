<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VCB Dashboard — Daily by date</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root{ --bg:#041226; --panel:#071227; --muted:#98a8bd; --accentA:#7dd3fc; --accentB:#8b5cf6; --done:#16a34a; --todo:#f97316; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Arial;background:linear-gradient(180deg,#021026,#05122a);color:#eaf6ff}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px}
  h1{margin:0;font-size:20px}
  .actions{display:flex;gap:8px;align-items:center}
  button, select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--accentA);cursor:pointer}
  .layout{display:grid;grid-template-columns:320px 1fr 420px;gap:12px;height:calc(100vh - 72px);padding:12px}
  .panel{background:var(--panel);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 40px rgba(2,6,23,0.45);display:flex;flex-direction:column;min-height:0;overflow:hidden}
  .taskList{overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:6px}
  .taskCard{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.04));border:1px solid rgba(255,255,255,0.02)}
  .small{font-size:12px;color:var(--muted)}
  canvas{width:100% !important;height:260px !important;display:block}
  table{width:100%;border-collapse:collapse;color:#eaf6ff;font-size:13px}
  thead th{background:rgba(10,14,24,0.35);padding:8px;color:var(--muted);text-align:left}
  td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
  #debug{margin-top:8px;background:#071427;color:#fff;padding:8px;border-radius:8px;font-size:13px;max-height:160px;overflow:auto}
</style>
</head>
<body>
<header>
  <div>
    <h1>VCB Dashboard</h1>
    <div class="small">Live • <span id="liveDate">—</span></div>
  </div>
  <div class="actions">
    <select id="scaleMode" title="Scale mode">
      <option value="auto">Auto scale</option>
      <option value="raw">Raw</option>
      <option value="log">Log</option>
    </select>
    <button id="refreshBtn">Refresh</button>
    <button id="uploadBtn">Upload JSON</button>
    <button id="pasteBtn">Paste JSON</button>
  </div>
</header>

<div class="layout">
  <div class="panel">
    <h3 style="margin:0 0 8px 0">Daily tasks</h3>
    <div id="dailyList" class="taskList"></div>
    <div style="height:10px"></div>
    <h3 style="margin:8px 0 8px 0">Weekly tasks</h3>
    <div id="weeklyList" class="taskList"></div>
  </div>

  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0">Counted vs Remaining — by date</h3>
      <div class="small" id="countHint">—</div>
    </div>
    <canvas id="piBar"></canvas>

    <h3 style="margin-top:18px">Weekly PI — Series</h3>
    <canvas id="weeklyLine"></canvas>

    <div id="debug"></div>
  </div>

  <div class="panel">
    <h3 style="margin:0 0 8px 0">Daily totals (table)</h3>
    <div style="overflow:auto">
      <table id="dailyTable"><thead><tr><th>Date</th><th style="text-align:right">Counted</th><th style="text-align:right">Remaining</th></tr></thead><tbody></tbody></table>
    </div>
    <div style="height:12px"></div>
    <h3 style="margin:0 0 8px 0">Gauge</h3>
    <canvas id="gaugeMini"></canvas>
  </div>
</div>

<script>
/* CONFIG */
const DAILY_TARGET = 1193;
const JSON_PATH = 'data/dashboard.json';

/* HELPERS */
function dbg(msg){ const el=document.getElementById('debug'); const d=document.createElement('div'); d.textContent=(new Date()).toLocaleTimeString() + ' — ' + msg; el.appendChild(d); el.scrollTop = el.scrollHeight; console.log(msg); }
function safeNum(v){ if(v==null) return 0; if(typeof v==='number') return isFinite(v)?v:0; const s=String(v).replace(/,/g,'').trim(); const n=Number(s); return isFinite(n)?n:0; }
function findKey(obj, candidates){ if(!obj) return undefined; if(!Array.isArray(candidates)) candidates=[candidates]; const ks=Object.keys(obj||{}); for(const c of candidates){ for(const k of ks) if(k.trim().toLowerCase()===c.trim().toLowerCase()) return k; } for(const c of candidates){ for(const k of ks) if(k.trim().toLowerCase().indexOf(c.trim().toLowerCase())!==-1) return k; } return undefined; }
function parseDateFlexible(s){
  if(!s) return null;
  // Accept dd.mm.yyyy or dd/mm/yyyy or ISO
  const str = String(s).trim();
  // dd.mm.yyyy or dd/mm/yyyy
  const m1 = str.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);
  if(m1){
    const d = Number(m1[1]), mo = Number(m1[2]), y = Number(m1[3]);
    return new Date(y, mo-1, d);
  }
  const iso = new Date(str);
  return isNaN(iso.getTime()) ? null : iso;
}
function formatDateShort(d){
  if(!d) return '';
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return `${dd}.${mm}.${yyyy}`;
}

/* CHART helpers: target line plugin */
const targetLine = {
  id: 'targetLine',
  afterDraw(chart, args, opts){
    if(!opts || typeof opts.value !== 'number') return;
    const {ctx, chartArea, scales} = chart;
    const yScale = scales.y;
    const y = yScale.getPixelForValue(opts.value);
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(chartArea.left, y);
    ctx.lineTo(chartArea.right, y);
    ctx.lineWidth = 2;
    ctx.strokeStyle = opts.color || 'rgba(255,255,255,0.12)';
    ctx.setLineDash([6,6]);
    ctx.stroke();
    ctx.fillStyle = opts.color || 'rgba(255,255,255,0.12)';
    ctx.font = '600 12px Poppins';
    ctx.textAlign = 'right';
    ctx.fillText('Target ' + opts.value.toLocaleString(), chartArea.right - 6, y - 8);
    ctx.restore();
  }
};
Chart.register(targetLine);

/* STATE */
let payload = null;
let charts = { piBar:null, weeklyLine:null, gauge:null };

/* LOAD JSON */
async function loadJSON(){
  dbg('Loading JSON from ' + JSON_PATH);
  try{
    const res = await fetch(JSON_PATH, { cache: 'no-store' });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    dbg('JSON loaded');
    return j;
  } catch(e){
    dbg('Failed to load JSON: ' + e.message);
    return null;
  }
}

/* AGGREGATE weeklyPiData by Date using Daily Qty */
function aggregateDailyFromWeeklyPi(weeklyPi){
  const resultMap = new Map();
  if(!Array.isArray(weeklyPi)) return resultMap;
  // keys: Date (string) -> sum(Daily Qty)
  const dailyKeyCandidates = ['Daily Qty','DailyQty','Daily Qty ','Daily','Daily_Qty'];
  const dateKeyCandidates = ['Date','DATE','date'];
  const dailyKey = findKey(weeklyPi[0]||{}, dailyKeyCandidates) || 'Daily Qty';
  const dateKey = findKey(weeklyPi[0]||{}, dateKeyCandidates) || 'Date';
  for(const r of weeklyPi){
    if(!r) continue;
    const rawDate = r[dateKey] ?? r['Date'] ?? r['DATE'] ?? r.date;
    const d = parseDateFlexible(rawDate);
    if(!d) continue; // skip invalid
    const key = formatDateShort(d);
    const qty = safeNum(r[dailyKey] ?? r['Daily Qty'] ?? r['DailyQty'] ?? r['Daily'] ?? 0);
    resultMap.set(key, (resultMap.get(key) || 0) + qty);
  }
  return resultMap;
}

/* RENDER Counted vs Remaining per DATE */
function renderDailyBarsFromWeeklyPi(weeklyPi){
  const map = aggregateDailyFromWeeklyPi(weeklyPi);
  if(map.size === 0){
    dbg('No daily data available in weeklyPiData to build daily bars.');
    // fallback: clear chart
    try{ if(charts.piBar) charts.piBar.destroy(); } catch(e){}
    document.getElementById('countHint').innerText = 'No daily data';
    return;
  }

  // sort dates ascending
  const items = Array.from(map.entries()).map(([dateStr, qty]) => {
    // parse back to Date for sorting
    const d = parseDateFlexible(dateStr);
    return { dateStr, qty: safeNum(qty), d: d || new Date(dateStr) };
  }).sort((a,b) => a.d - b.d);

  const labels = items.map(i => i.dateStr);
  const counted = items.map(i => i.qty);
  const remaining = items.map(i => Math.max(0, DAILY_TARGET - i.qty));
  const totalCountAllDays = counted.reduce((s,x)=>s+x,0);

  // table
  const tbody = document.querySelector('#dailyTable tbody'); tbody.innerHTML = '';
  for(let i=0;i<items.length;i++){
    tbody.insertAdjacentHTML('beforeend', `<tr><td>${labels[i]}</td><td style="text-align:right">${counted[i].toLocaleString()}</td><td style="text-align:right">${remaining[i].toLocaleString()}</td></tr>`);
  }

  // chart: grouped bars (Counted, Remaining)
  try{ if(charts.piBar) charts.piBar.destroy(); } catch(e){}
  const ctx = document.getElementById('piBar').getContext('2d');
  charts.piBar = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'Counted (Daily Qty)', data: counted, backgroundColor: '#7dd3fc' },
        { label: 'Remaining to 1,193', data: remaining, backgroundColor: '#f97316' }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: {
        legend: { position: 'top' },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString() } },
        targetLine: { value: DAILY_TARGET, color: 'rgba(255,255,255,0.16)' }
      },
      scales: {
        x: { stacked: false },
        y: { beginAtZero:true, ticks: { callback: v => v >= 1000 ? (v/1000).toFixed(1)+'K' : v } }
      }
    }
  });

  // gauge: compute latest day (last item)
  const last = items[items.length-1];
  renderGaugeForValue(last.qty);

  document.getElementById('countHint').innerText = `Days: ${labels.length} • Last day ${labels[labels.length-1]} • Last counted ${formatNumber(last.qty)}`;
}

/* Gauge helper */
function renderGaugeForValue(value){
  try{ if(charts.gauge) charts.gauge.destroy(); } catch(e){}
  const ctx = document.getElementById('gaugeMini').getContext('2d');
  const rem = Math.max(0, DAILY_TARGET - value);
  charts.gauge = new Chart(ctx, {
    type:'doughnut',
    data:{ labels:['Counted','Remaining'], datasets:[{ data:[value, rem], backgroundColor:['#7dd3fc','#f97316'] }]},
    options:{ rotation:-Math.PI, circumference:Math.PI, responsive:false, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
  });
}

/* Render weekly series (existing behavior) */
function renderWeeklySeries(weeklyPi){
  if(!Array.isArray(weeklyPi) || weeklyPi.length===0){ try{ if(charts.weeklyLine) charts.weeklyLine.destroy(); }catch(e){} document.getElementById('weekHint')?.innerText = '—'; return; }
  const wkKey = findKey(weeklyPi[0], ['Week No','WeekNo','Week']);
  const weeklyQtyKey = findKey(weeklyPi[0], ['Weekly Qty','WeeklyQty','Weekly Qty']);
  const labelsSet = new Set();
  const agg = {};
  for(const r of weeklyPi){
    const wk = r[wkKey] ?? r['Week No'] ?? r['WeekNo'] ?? r.WeekNo ?? '';
    if(!wk) continue;
    const qty = safeNum(r[weeklyQtyKey] ?? r['Weekly Qty'] ?? r['WeeklyQty'] ?? 0);
    agg[wk] = (agg[wk]||0) + qty;
    labelsSet.add(String(wk));
  }
  const labels = Array.from(labelsSet).sort((a,b) => (isFinite(Number(a)) && isFinite(Number(b))) ? Number(a)-Number(b) : String(a).localeCompare(String(b)));
  const values = labels.map(l => agg[l] || 0);
  try{ if(charts.weeklyLine) charts.weeklyLine.destroy(); }catch(e){}
  const ctx = document.getElementById('weeklyLine').getContext('2d');
  charts.weeklyLine = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:'Weekly qty', data:values, borderColor:'#8b5cf6', backgroundColor:'rgba(139,92,246,0.08)', fill:true }]}, options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ ticks:{ callback: v => v>=1000 ? (v/1000).toFixed(1)+'K' : v } } } } });
  document.getElementById('weekHint')?.innerText = 'Weeks: ' + labels.length;
}

/* BOOT / UI wiring */
document.getElementById('refreshBtn').addEventListener('click', async () => {
  const j = await loadJSON();
  if(!j) { dbg('No JSON loaded'); return; }
  payload = j;
  document.getElementById('liveDate').innerText = (new Date()).toLocaleDateString();
  renderWeeklySeries(payload.weeklyPiData || []);
  renderDailyBarsFromWeeklyPi(payload.weeklyPiData || []);
});
document.getElementById('uploadBtn').addEventListener('click', ()=>{
  const input=document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = e => { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload = ev => { try{ payload = JSON.parse(ev.target.result); dbg('Uploaded JSON parsed'); renderWeeklySeries(payload.weeklyPiData||[]); renderDailyBarsFromWeeklyPi(payload.weeklyPiData||[]); }catch(err){ dbg('Upload parse error: '+err.message); alert('Invalid JSON'); } }; r.readAsText(f); }; input.click();
});
document.getElementById('pasteBtn').addEventListener('click', ()=>{
  const txt = prompt('Paste dashboard JSON here');
  if(!txt) return;
  try{ payload = JSON.parse(txt); dbg('Pasted JSON parsed'); renderWeeklySeries(payload.weeklyPiData||[]); renderDailyBarsFromWeeklyPi(payload.weeklyPiData||[]); } catch(e){ dbg('Paste parse error: '+e.message); alert('Invalid JSON'); }
});

/* INITIAL LOAD */
(async ()=>{
  const j = await loadJSON();
  if(!j){ dbg('Failed to load JSON. Use Upload/Paste.'); return; }
  payload = j;
  document.getElementById('liveDate').innerText = (new Date()).toLocaleDateString();
  renderWeeklySeries(payload.weeklyPiData || []);
  renderDailyBarsFromWeeklyPi(payload.weeklyPiData || []);
})();
</script>
</body>
</html>
